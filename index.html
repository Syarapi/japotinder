<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Japontinder</title>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --yes:#87cefa;
    --meh:#8a5adf;
    --no:#ff7aa3;
    --ink:#333;
    --bg-light:#fff7fb;
    --card-bg:#ffffffee;
    --accent-1:#d7a6f1;
    --accent-2:#b48ad6;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; }
  body {
    font-family: 'Segoe UI', sans-serif;
    color: var(--ink);
    background: var(--bg-light);
    position: relative;
    overflow: hidden; /* sin scroll global; cada bloque tiene su propio scroll */
  }
  #sakuraCanvas{
    position: fixed; inset: 0;
    z-index: 0; pointer-events: none;
  }
  h1, h2, h3 { font-family: 'Yuji Syuku', serif; text-align: center; margin: 8px 0; }
  h1 { color: var(--accent-1); text-shadow: 0 2px 0 #fff; }
  h2 { color: var(--accent-2); }
  h3 { color: var(--accent-1); }

  .screen { display: none; position: relative; z-index: 1; }

  #start-screen, #mode-screen {
    display: flex; align-items: center; justify-content: center;
    height: 100vh; width: 100vw; padding: 16px;
  }
  #game-screen, #results-screen {
    height: 100vh; width: 100vw; padding: 10px 12px;
    display:flex; flex-direction: column; align-items: center;
  }

  .start-card{
    width: 92%; max-width: 420px;
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    text-align: center;
  }
  input {
    padding: 12px 14px; font-size: 16px; border-radius: 10px;
    border: 2px solid var(--accent-1); width: 220px; text-align: center;
    background: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.08);
  }
  .btn {
    padding: 12px 18px;
    font-size: 16px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.12);
    color: white;
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.16); }
  .btn:active { transform: translateY(0); opacity:.95; }
  .accept { background: linear-gradient(180deg, var(--yes) 0%, #5fb5ef 100%); }
  .meh    { background: linear-gradient(180deg, var(--meh) 0%, #7343d8 100%); }
  .reject { background: linear-gradient(180deg, var(--no) 0%, #ff5f93 100%); }
  .stats-btn { background: linear-gradient(180deg, var(--accent-1) 0%, var(--accent-2) 100%); color: #fff; }

  /* Pantalla de modo dividida en 2 botones */
  .mode-split{
    position: relative; width: 100vw; height: 100vh;
    display: grid; grid-template-columns: 1fr 1fr;
  }
  .mode-half{
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; gap: 10px; cursor: pointer; padding: 20px;
    transition: transform .15s ease; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.25);
  }
  .mode-half:hover{ transform: scale(1.01); }
  .mode-title{ font-size: clamp(26px, 4vw, 40px); font-weight: 800; text-align: center; }
  .mode-desc{ font-size: clamp(14px, 2vw, 18px); opacity: .95; text-align: center; max-width: 580px; }

  /* Tarjeta de juego */
  .card{
    width: min(88vw, 380px);
    height: min(70vh, 520px);
    border-radius: 18px;
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    box-shadow: 0 14px 28px rgba(0,0,0,.15);
    overflow: hidden;
    position: relative;
    touch-action: none;
  }
  .card img{
    width:100%; height:100%; object-fit: cover;
    display:block; filter: saturate(1.05);
  }
  .card-name{
    position:absolute; left:10px; right:10px; bottom:10px;
    background: rgba(255,255,255,.86);
    padding: 8px 12px;
    border-radius: 12px;
    font-weight: 700;
    border: 1px solid var(--accent-1);
    text-align: center;
  }

  /* Resultados: 2x2 con scroll interno en cada bloque */
  .results-grid{
    flex:1;
    width: 100%;
    max-width: 1200px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 10px;
    min-height: 0; /* permite que los hijos usen overflow */
  }
  .card-block{
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    border-radius: 16px;
    padding: 10px;
    display:flex; flex-direction: column;
    min-height: 0; /* para que inner-scroll funcione */
    box-shadow: 0 10px 24px rgba(0,0,0,.12);
  }
  .block-title{ margin:4px 0 8px; font-size: 18px; }
  .inner-scroll{
    flex:1; overflow:auto; border-radius: 10px; background: #fff;
    padding: 6px;
  }
  .x-scroll{ overflow-x: auto; overflow-y: hidden; }

  /* Tablas compactas con tipografía pequeña y scroll interno */
  table { border-collapse: collapse; width: 100%; }
  .compact-table th, .compact-table td{
    border-bottom: 1px solid #eee;
    padding: 6px 8px;
    font-size: 13px;
    text-align: left;
    vertical-align: top;
  }
  .compact-table thead th{ position: sticky; top:0; background:#fff; z-index:1; }
  .smaller-cards{ font-size: 12px; line-height: 1.3; }
  .wide-table { table-layout: fixed; }
  .wide-table th:first-child, .wide-table td:first-child { width: 56%; } /* más ancha para “Top tarjetas” */
  .wide-table th, .wide-table td { font-size: 12px; } /* un poco más pequeño para que quepa todo */
</style>
</head>
<body>
<canvas id="sakuraCanvas"></canvas>

<!-- Pantalla de inicio -->
<div id="start-screen" class="screen" style="display:flex;">
  <div class="start-card">
    <h1>Japontinder</h1>
    <p>Introduce tu nombre para empezar</p>
    <input type="text" id="playerName" placeholder="Tu nombre" />
    <br/><br/>
    <button class="btn stats-btn" onclick="goToModeScreen()">Continuar</button>
  </div>
</div>

<!-- Pantalla de selección de modo -->
<div id="mode-screen" class="screen">
  <div class="mode-split">
    <div class="mode-half" id="shortMode" onclick="startGame('short')">
      <div class="mode-title">Versión corta</div>
      <div class="mode-desc">Menos tarjetas, partida rápida.</div>
    </div>
    <div class="mode-half" id="longMode" onclick="startGame('long')">
      <div class="mode-title">Versión larga</div>
      <div class="mode-desc">Más tarjetas para un juego completo.</div>
    </div>
  </div>
</div>

<!-- Pantalla de juego -->
<div id="game-screen" class="screen">
  <h2 id="playerLabel"></h2>
  <div id="card-container" style="flex:1; display:flex; align-items:center; justify-content:center; position:relative;">
    <!-- Tarjeta actual se carga aquí -->
  </div>
  <div style="display:flex; gap: 8px; margin-top: 10px;">
    <button class="btn reject" onclick="handleChoice('no')">Pasando</button>
    <button class="btn meh" onclick="handleChoice('meh')">Me da igual</button>
    <button class="btn accept" onclick="handleChoice('yes')">Aquí sí</button>
  </div>
</div>

<!-- Pantalla de resultados -->
<div id="results-screen" class="screen">
  <h2 id="resultsTitle">Resultados</h2>
  <div id="playerMeta"></div>

  <div class="results-grid">
    <!-- Gráfico (arriba-izquierda) -->
    <div class="card-block" id="chartBlock">
      <h3 class="block-title">Distribución de votos por tarjeta</h3>
      <div class="inner-scroll x-scroll">
        <canvas id="statsChart" height="300"></canvas>
      </div>
    </div>

    <!-- Top tarjetas (arriba-derecha) -->
    <div class="card-block" id="topBlock">
      <h3 class="block-title">Top tarjetas con más “sí”</h3>
      <div class="inner-scroll">
        <table class="compact-table wide-table" id="topTable">
          <thead>
            <tr><th>Tarjeta</th><th>Sí</th><th>Meh</th><th>No</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Afinidad global (abajo-izquierda) -->
    <div class="card-block" id="affGlobalBlock">
      <h3 class="block-title">Ranking de afinidad (todos) — por Pareja</h3>
      <div class="inner-scroll">
        <table class="compact-table" id="affGlobalTable">
          <thead>
            <tr><th>Pareja</th><th># Coincidencias SÍ</th><th class="smaller-cards">Tarjetas en común (SÍ)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Afinidad personal (abajo-derecha) -->
    <div class="card-block" id="affPersonalBlock">
      <h3 class="block-title">Jugadores más afines contigo</h3>
      <div class="inner-scroll">
        <table class="compact-table" id="affPersonalTable">
          <thead>
            <tr><th>Jugador</th><th># Coincidencias SÍ</th><th class="smaller-cards">Tarjetas en común (SÍ)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="margin-top:10px;text-align:center;">
    <button class="btn stats-btn" onclick="goToStart()">Volver al inicio</button>
  </div>
</div>

<script>
/* =========================
   CONFIG & CONSTANTES
========================= */
const saveEndpoint = "/api/save";
const dataUrl      = "https://raw.githubusercontent.com/Syarapi/japotinder/main/results/data.json";

const MEH_LIMIT = { short: 5, long: 10 };
const SHORT_COUNT = 20;

const BASE_CARDS = [
  { name: "Disney Tokyo", img: "img/disney.jpg" },
  { name: "Gotokuji", img: "img/gotokuji.jpg" },
  { name: "Pokemon Cafe", img: "img/pokemon.jpg" },
  { name: "Shikisai no oka", img: "img/shikisai.jpg" },
  { name: "Shinkansen Hello Kitty", img: "img/hello-kitty.jpg" },
  { name: "Maid cafe", img: "img/maid.jpg" },
  { name: "Nabana no sato", img: "img/nabana.jpg" },
  { name: "Otaru", img: "img/otaru.jpg" },
  { name: "Nagano y monos de nieve", img: "img/nagano.jpg" },
  { name: "RJ Cafe Osaka", img: "img/rj-cafe.jpg" },
  { name: "Kumachan Onsen Tokyo", img: "img/kumachan.jpg" },
  { name: "Enoshima", img: "img/enoshima.jpg" },
  { name: "Ginzan Onsen", img: "img/ginzan.jpg" },
  { name: "Tarde de recreativas", img: "img/arcade.jpg" },
  { name: "Shibazakura park Hokkaido", img: "img/shibazakura.jpg" },
  { name: "Musical Tokyo Revengers", img: "img/tokyo-revengers.jpg" },
  { name: "Eventos Kisekoi/Sailor Moon", img: "img/kisekoi.jpg" },
  { name: "Museo/cafe de los yokai", img: "img/yokai.jpg" },
  { name: "Kumamoto", img: "img/kumamoto.jpg" },
  { name: "Beppu", img: "img/beppu.jpg" },
  { name: "Bandai Museum", img: "img/bandai.jpg" }
];

/* =========================
   UTILIDADES GENERALES
========================= */
const $ = (sel) => document.querySelector(sel);
const shuffle = (arr) => arr.slice().sort(()=>Math.random()-0.5);
function nowStr(){ return new Date().toLocaleString(); }

/* =========================
   TEMA ALEATORIO + PÉTALOS
========================= */
const THEMES = [
  { name:"sakura", light:"#fff7fb", mid:"#ffe3ef", dark:"#d38cb1", a1:"#d7a6f1", a2:"#b48ad6" },
  { name:"sky",    light:"#f2f9ff", mid:"#e0f1ff", dark:"#8dbfe6", a1:"#a3c9ff", a2:"#7fb2f0" },
  { name:"lav",    light:"#faf5ff", mid:"#efe3ff", dark:"#b48ad6", a1:"#d7a6f1", a2:"#b48ad6" },
  { name:"sun",    light:"#fff9e0", mid:"#ffefb0", dark:"#e0c050", a1:"#f0d46a", a2:"#e1b84f" },
  { name:"mint",   light:"#edfff7", mid:"#d8ffee", dark:"#68cba7", a1:"#9fe6cc", a2:"#68cba7" }
];

const BUTTON_FAMILIES = {
  yes: ["#87cefa","#72bff2","#64b2ef","#5fb5ef"],
  meh: ["#8a5adf","#7e4fd8","#7343d8","#9a6af0"],
  no:  ["#ff7aa3","#ff6b9b","#ff5f93","#ff85b1"]
};

function applyThemeRandom() {
  const t = THEMES[Math.floor(Math.random()*THEMES.length)];
  const r = document.documentElement.style;
  r.setProperty("--bg-light", t.light);
  r.setProperty("--bg-mid",   t.mid);
  r.setProperty("--bg-dark",  t.dark);
  r.setProperty("--accent-1", t.a1);
  r.setProperty("--accent-2", t.a2);

  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  r.setProperty("--yes", pick(BUTTON_FAMILIES.yes));
  r.setProperty("--meh", pick(BUTTON_FAMILIES.meh));
  r.setProperty("--no" , pick(BUTTON_FAMILIES.no));

  // Colores de los dos botones de modo
  const short = document.getElementById("shortMode");
  const long  = document.getElementById("longMode");
  if(short) short.style.background = r.getPropertyValue("--yes");
  if(long)  long.style.background  = r.getPropertyValue("--meh");

  setPetalColorFromHex(t.mid);
}

function hexToRGB(hex){
  const h = hex.replace("#","");
  const bigint = parseInt(h.length===3 ? h.split("").map(c=>c+c).join("") : h,16);
  return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
}
function darker([r,g,b], f=0.75){
  return [Math.floor(r*f), Math.floor(g*f), Math.floor(b*f)];
}
function setPetalColorFromHex(hex){
  const rgb = hexToRGB(hex);
  const d = darker(rgb, 0.75);
  document.documentElement.style.setProperty("--petal-rgba", `${d[0]},${d[1]},${d[2]}`);
}

function sakuraLoop(){
  const canvas = document.getElementById("sakuraCanvas");
  const c = canvas.getContext("2d");
  const petals = [];
  let w,h;
  function resize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
  window.addEventListener("resize", resize); resize();

  for(let i=0;i<60;i++){
    petals.push({
      x: Math.random()*w, y: Math.random()*h, s: Math.random()*2+1,
      v: Math.random()*0.6+0.4, a: Math.random()*Math.PI*2
    });
  }
  function rgbaPetal(alpha){
    const [r,g,b] = getComputedStyle(document.documentElement)
                     .getPropertyValue("--petal-rgba").split(",").map(x=>+x.trim());
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function draw(){
    c.clearRect(0,0,w,h);
    for(const p of petals){
      p.y += p.v; p.x += Math.sin(p.a)*0.6; p.a += 0.01;
      if(p.y>h+20){ p.y=-10; p.x=Math.random()*w; }
      c.beginPath(); c.fillStyle = rgbaPetal(0.25);
      c.ellipse(p.x, p.y, 8*p.s, 5*p.s, p.a, 0, Math.PI*2); c.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
}

/* =========================
   COLORES DE JUGADORES (ÚNICOS)
========================= */
const PLAYER_COLOR_POOL = [
  "#8a5adf","#6f4bd4","#a27af0","#9a6f0",
  "#ff7aa3","#ff6b9b","#ff85b1",
  "#20b2aa","#2aa79b","#1fa8a0",
  "#e0c050","#d6b140",
  "#68cba7","#56bfa0",
  "#7fb2f0","#72bff2","#64b2ef"
];
const RESERVED = {
  "alba": "#2f7bdc",      // único azul
  "alicia": "#8a5adf",    // morado 1
  "vaini":  "#6f4bd4",    // morado 2
  "sara":   "#ff6fa1"     // rosa
};
const playerColorMap = new Map();

function getPlayerColorDeterministic(name){
  const n = (name||"").trim(); const key = n.toLowerCase();
  if(playerColorMap.has(key)) return playerColorMap.get(key);
  if(RESERVED[key]){ playerColorMap.set(key, RESERVED[key]); return RESERVED[key]; }

  const FORBIDDEN = new Set(["#2f7bdc","#1e90ff","#007bff","#0066ff"]);
  const used = new Set([...playerColorMap.values(), ...Object.values(RESERVED)]);
  let hash=0; for(let i=0;i<key.length;i++) hash = (hash*31 + key.charCodeAt(i))|0;

  for(let i=0;i<PLAYER_COLOR_POOL.length;i++){
    const idx = Math.abs(hash + i) % PLAYER_COLOR_POOL.length;
    const cand = PLAYER_COLOR_POOL[idx];
    if(!used.has(cand) && !FORBIDDEN.has(cand)){
      playerColorMap.set(key, cand); return cand;
    }
  }
  const fallback = `hsl(${(Math.abs(hash)%180)+160} 70% 45%)`; // azules verdosos si hace falta
  playerColorMap.set(key, fallback); return fallback;
}

/* =========================
   ESTADO & NAVEGACIÓN
========================= */
let mode = null;       // 'short' | 'long'
let playerName = "";
let cards = [];
let idx = 0;
let acc = [];
let rej = [];
let meh = [];

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="flex";
}

function goToStart(){
  showScreen("start-screen");
}

function goToModeScreen(){
  const name = (document.getElementById("playerName").value||"").trim();
  if(!name){ alert("¡Pon tu nombre!"); return; }
  playerName = name;
  $("#playerLabel") && ($("#playerLabel").textContent = `Jugador: ${playerName}`);
  showScreen("mode-screen");
}

/* =========================
   JUEGO
========================= */
function startGame(m){
  mode = (m==="short") ? "short" : "long";
  idx = 0; acc=[]; rej=[]; meh=[];
  cards = shuffle(BASE_CARDS);
  if(mode==="short") cards = cards.slice(0, SHORT_COUNT);
  loadCard();
  showScreen("game-screen");
}

function cardHTML(item){
  return `
    <div class="card" id="card">
      <img src="${item.img}" alt="${item.name}">
      <div class="card-name">${item.name}</div>
    </div>`;
}

function attachSwipe(el, onCommit){
  let sx=0, sy=0, dx=0, dy=0, active=false;
  const start=(x,y)=>{ active=true; sx=x; sy=y; dx=0; dy=0; el.style.transition=""; };
  const move=(x,y)=>{ if(!active) return; dx=x-sx; dy=y-sy;
    const rot=dx*0.05;
    el.style.transform=`translate(${dx}px,${dy}px) rotate(${rot}deg)`;
    el.style.opacity=String(1-Math.min(0.6, Math.abs(dx)/300 + Math.max(0,-dy)/300)); };
  const end=()=>{ if(!active) return; active=false;
    const THX=80, THY=-80;
    if(dx<=-THX) return onCommit("no");
    if(dx>= THX) return onCommit("yes");
    if(dy<= THY) return onCommit("meh");
    el.style.transition="transform .2s ease, opacity .2s ease";
    el.style.transform="translate(0,0) rotate(0)"; el.style.opacity="1";
  };
  el.addEventListener("touchstart", e=>start(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
  el.addEventListener("touchmove",  e=>move(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
  el.addEventListener("touchend", end);
  el.addEventListener("mousedown", e=>start(e.clientX, e.clientY));
  window.addEventListener("mousemove", e=>move(e.clientX, e.clientY));
  window.addEventListener("mouseup", end);
}

function loadCard(){
  const cc = document.getElementById("card-container");
  cc.innerHTML = "";
  if(idx >= cards.length){ return endGame(); }
  cc.insertAdjacentHTML("beforeend", cardHTML(cards[idx]));
  const el = document.getElementById("card");
  attachSwipe(el, (choice)=>commit(choice));
}

function handleChoice(kind){ commit(kind); }

function commit(kind){
  const el = document.getElementById("card");
  if(!el) return;
  const name = el.querySelector(".card-name").textContent;
  if(kind==="yes") acc.push(name);
  else if(kind==="no") rej.push(name);
  else {
    if(meh.length >= MEH_LIMIT[mode||"short"]){
      alert("Por favor, mójate un poco más…");
      el.style.transition="transform .2s ease, opacity .2s ease";
      el.style.transform="translate(0,0) rotate(0)"; el.style.opacity="1";
      return;
    }
    meh.push(name);
  }
  idx++;
  loadCard();
}

async function endGame(){
  showScreen("results-screen");
  const meta = `Jugador: <span style="font-weight:700; color:${getPlayerColorDeterministic(playerName)}">${playerName}</span> · Modo: ${mode==="short"?"Corto":"Largo"} · ${nowStr()}`;
  $("#playerMeta").innerHTML = meta;

  try{
    await fetch(saveEndpoint, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ player: playerName, date: nowStr(), mode, accepted: acc, meh, rejected: rej })
    });
  }catch(e){ console.warn("No se pudo guardar:", e); }

  renderStats();
}

/* =========================
   ESTADÍSTICAS + GRÁFICO
========================= */
let chartInstance = null;
function destroyChart(){ if(chartInstance){ chartInstance.destroy(); chartInstance = null; } }
function ensureGames(json){ if(Array.isArray(json)) return json; if(json && Array.isArray(json.games)) return json.games; return []; }

async function fetchGames(){
  try{
    const res = await fetch(`${dataUrl}?t=${Date.now()}`);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    return ensureGames(j).map(g=>({
      player: g.player||"¿anon?",
      mode: g.mode||"unknown",
      accepted: Array.isArray(g.accepted) ? g.accepted : [],
      meh: Array.isArray(g.meh) ? g.meh : [],
      rejected: Array.isArray(g.rejected) ? g.rejected : []
    }));
  }catch(e){
    console.warn("No se pudo leer data.json", e);
    return [];
  }
}

async function renderStats(){
  const games = await fetchGames();
  const allPlayers = [...new Set(games.map(g=>g.player).concat([playerName]))];
  allPlayers.forEach(p => getPlayerColorDeterministic(p));

  const stats = {};
  const up = (name, key)=>{ stats[name] = stats[name] || {yes:0, meh:0, no:0}; stats[name][key] += 1; };
  games.forEach(g=>{ g.accepted.forEach(n=>up(n,"yes")); g.meh.forEach(n=>up(n,"meh")); g.rejected.forEach(n=>up(n,"no")); });

  const labels = Object.keys(stats).sort((a,b)=>a.localeCompare(b));
  const yes  = labels.map(l=>stats[l].yes);
  const mehD = labels.map(l=>stats[l].meh);
  const no   = labels.map(l=>stats[l].no);

  const canvas = document.getElementById("statsChart");
  const desiredWidth = Math.max(labels.length*42, 600);
  canvas.width = desiredWidth;

  const ctx = canvas.getContext("2d");
  const css = getComputedStyle(document.documentElement);
  const cYes = css.getPropertyValue("--yes").trim();
  const cMeh = css.getPropertyValue("--meh").trim();
  const cNo  = css.getPropertyValue("--no").trim();

  destroyChart();
  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label:"Aquí sí", data: yes,  backgroundColor: cYes, borderRadius: 6, stack:"s" },
        { label:"Me da igual", data: mehD, backgroundColor: cMeh, borderRadius: 6, stack:"s" },
        { label:"Pasando", data: no,  backgroundColor: cNo,  borderRadius: 6, stack:"s" }
      ]
    },
    options:{
      responsive:false, maintainAspectRatio:false,
      scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } },
      plugins:{
        legend:{ labels:{ color:"#333" } },
        tooltip:{ backgroundColor:"rgba(255,255,255,.95)", titleColor:"#333", bodyColor:"#333", borderColor:"#ddd", borderWidth:1 }
      }
    }
  });

  // Top tarjetas
  const top = Object.entries(stats)
    .sort((a,b)=> b[1].yes - a[1].yes || a[0].localeCompare(b[0]))
    .slice(0, 12);
  const topBody = $("#topTable tbody");
  topBody.innerHTML = top.map(([n,v]) =>
    `<tr><td>${n}</td><td>${v.yes}</td><td>${v.meh}</td><td>${v.no}</td></tr>`).join("");

  // Afinidades por intersección de SÍ
  const byPlayer = {};
  games.forEach(g=>{
    byPlayer[g.player] = byPlayer[g.player] || [];
    byPlayer[g.player].push(new Set(g.accepted));
  });
  Object.keys(byPlayer).forEach(p=>{
    const u = new Set(); byPlayer[p].forEach(s=>s.forEach(x=>u.add(x))); byPlayer[p]=u;
  });

  const players = Object.keys(byPlayer).sort((a,b)=>a.localeCompare(b));

  // Global (parejas)
  const pairs = [];
  for(let i=0;i<players.length;i++){
    for(let j=i+1;j<players.length;j++){
      const p1=players[i], p2=players[j];
      const inter=[]; byPlayer[p1].forEach(x=>{ if(byPlayer[p2].has(x)) inter.push(x); });
      if(inter.length>0) pairs.push({ a:p1,b:p2, common:inter.sort(), count:inter.length });
    }
  }
  pairs.sort((x,y)=> y.count - x.count || (x.a+x.b).localeCompare(y.a+y.b));

  const affGBody = $("#affGlobalTable tbody");
  affGBody.innerHTML = pairs.slice(0,50).map(row=>{
    const cA = getPlayerColorDeterministic(row.a);
    const cB = getPlayerColorDeterministic(row.b);
    return `<tr>
      <td><span style="color:${cA};font-weight:600">${row.a}</span> &amp; <span style="color:${cB};font-weight:600">${row.b}</span></td>
      <td>${row.count}</td>
      <td class="smaller-cards">${row.common.join(", ")}</td>
    </tr>`;
  }).join("");

  // Personal
  const me = playerName;
  const personal = [];
  if(me && byPlayer[me]){
    const mine = byPlayer[me];
    players.filter(p=>p!==me).forEach(p=>{
      const inter=[]; byPlayer[p].forEach(x=>{ if(mine.has(x)) inter.push(x); });
      if(inter.length) personal.push({ player:p, list:inter.sort(), count:inter.length });
    });
    personal.sort((a,b)=> b.count - a.count || a.player.localeCompare(b.player));
  }
  const affPBody = $("#affPersonalTable tbody");
  affPBody.innerHTML = personal.slice(0,50).map(r=>{
    const c = getPlayerColorDeterministic(r.player);
    return `<tr>
      <td style="color:${c};font-weight:600">${r.player}</td>
      <td>${r.count}</td>
      <td class="smaller-cards">${r.list.join(", ")}</td>
    </tr>`;
  }).join("");
}

/* =========================
   INICIALIZACIÓN
========================= */
applyThemeRandom();
sakuraLoop();
showScreen("start-screen");
</script>
</body>
</html>
