<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Japontinder</title>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    /* Colores fijos para botones y series */
    --pink: #FFB7C5;     /* Pasando */
    --purple: #B19CD9;   /* Me da igual */
    --blue: #89CFF0;     /* Aquí sí */

    /* Paleta base para fondos/aleatorios */
    --sun: #FFE480;      /* Amarillo pastel legible */
    --mint: #A8E6CF;     /* Verde menta */
    --sakura: #FFD6E2;   /* Rosa sakura suave */
    --lav: #D7C8FF;      /* Lavanda claro */
    --sky: #D2EDFF;      /* Azul muy claro */

    --ink:#333;
    --shadow: 0 10px 25px rgba(0,0,0,0.15);

    /* Calculados por JS (aleatorios) */
    --bg-solid: #FFD6E2;
    --card-border: #FFD6E2;
    --card-bg: #ffffffee;
    --table-head-from: #EDE6FF;
    --table-head-to:   #DCD0FF;
    --accent-text: #5c2a4a;
  }

  /* ===== Fondo sakura dinámico (sólido + pétalos animados) ===== */
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    color: var(--ink);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--bg-solid); /* Color sólido (no degradado) */
    position: relative;
    overflow-x: hidden;
  }
  /* Capa de pétalos que caen con animación */
  .sakura-layer, .sakura-layer2{
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -1;
    background-repeat: repeat;
    animation: petalsFall 22s linear infinite;
    opacity: .9;
  }
  .sakura-layer2{
    animation-duration: 30s;
    opacity: .6;
    filter: blur(.4px);
  }
  /* Textura de pétalos dibujada con gradientes radiales */
  .sakura-layer{
    background-image:
      radial-gradient(14px 9px at 10px 10px, rgba(255,182,193,0.35) 40%, transparent 41%),
      radial-gradient(12px 8px at 40% 30%, rgba(255,182,193,0.26) 40%, transparent 41%),
      radial-gradient(10px 7px at 70% 60%, rgba(255,182,193,0.22) 40%, transparent 41%),
      radial-gradient(12px 8px at 85% 20%, rgba(255,182,193,0.28) 40%, transparent 41%);
    background-size: 220px 220px, 260px 260px, 240px 240px, 280px 280px;
    background-position: 0 -10vh, 20vw -20vh, 60vw -15vh, 85vw -25vh;
  }
  .sakura-layer2{
    background-image:
      radial-gradient(14px 9px at 15px 12px, rgba(255,182,193,0.25) 40%, transparent 41%),
      radial-gradient(12px 8px at 45% 35%, rgba(255,182,193,0.20) 40%, transparent 41%),
      radial-gradient(10px 7px at 65% 55%, rgba(255,182,193,0.18) 40%, transparent 41%);
    background-size: 260px 260px, 300px 300px, 280px 280px;
    background-position: 10vw -18vh, 35vw -22vh, 70vw -12vh;
  }
  @keyframes petalsFall {
    0%   { background-position: 0 -10vh, 20vw -20vh, 60vw -15vh, 85vw -25vh; }
    100% { background-position: 0 120vh, 20vw 130vh, 60vw 125vh, 85vw 135vh; }
  }

  h1, h2, h3 {
    font-family: 'Yuji Syuku', serif;
    text-align: center;
    text-shadow: 0 2px 0 #fff;
  }

  /* Contenedores principales */
  #start-screen, #mode-screen, #results, #stats-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    width: 100%;
  }
  #start-screen, #mode-screen { min-height: 100vh; justify-content: center; gap: 16px; }

  /* Tarjetas */
  #card-container {
    position: relative;
    width: 90%;
    max-width: 520px;
    height: 66vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    width: 100%;
    height: 100%;
    background: var(--card-bg);
    backdrop-filter: blur(3px);
    border-radius: 20px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 18px;
    box-sizing: border-box;
    border: 2px solid var(--card-border);
  }
  .card img {
    max-height: 85%;
    max-width: 100%;
    object-fit: cover;
    border-radius: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  }
  .card div {
    font-weight: 600;
    color: #8c4a78;
    padding-top: 6px;
  }

  /* Botones */
  #buttons { margin-top: 20px; display: flex; gap: 16px; z-index: 10; }
  .btn {
    padding: 14px 22px;
    font-size: 17px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.12);
    color: #fff;
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.16); }
  .btn:active { transform: translateY(0); opacity:.95; }
  .btn-yes  { background: linear-gradient(180deg, var(--blue) 0%, #5bb4e9 100%); }
  .btn-meh  { background: linear-gradient(180deg, var(--purple) 0%, #9f89d0 100%); }
  .btn-no   { background: linear-gradient(180deg, var(--pink) 0%, #ff91aa 100%); }
  .btn-stats{ background: linear-gradient(180deg, #d7a6f1 0%, #b28ae3 100%); }
  .btn-ghost{ background: #ffffffde; color:#444; border:1px solid #eee; }

  .results-container { display: flex; gap: 50px; justify-content: center; flex-wrap: wrap; }
  .list { margin: 10px 0; }
  ul { list-style: none; padding: 0; font-size: 18px; }
  input {
    padding: 12px 14px;
    font-size: 16px;
    border-radius: 10px;
    border: 2px solid var(--card-border);
    width: 220px;
    text-align: center;
    background: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
  }

  /* Tarjetas de modo */
  .mode-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px; width: min(920px,92vw); }
  .mode-card {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
    text-align: center;
  }
  .mode-card p { margin: 6px 0 14px; }

  /* Tablas */
  table {
    border-collapse: collapse;
    margin-top: 15px;
    width: 90%;
    max-width: 720px;
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border: 2px solid var(--card-border);
  }
  table th, table td {
    padding: 10px 14px;
    border-bottom: 1px solid #f1ebf6;
    text-align: left;
    vertical-align: top;
  }
  table th {
    background: linear-gradient(180deg, var(--table-head-from) 0%, var(--table-head-to) 100%);
    color: #3d2a68;
    letter-spacing:.3px;
  }
  table tr:nth-child(even) { background-color: #fbf7ff; }
  table tr:hover { background-color: #f6f0ff; transition: background .2s ease; }

  .notice { color: #6a4b7e; margin-top: 10px; }
  .error { color: #d6456a; margin-top: 10px; }
  .muted { color: #666; }

  /* ===== Layout de estadísticas ===== */
  .stats-layout {
    display: flex;
    gap: 24px;
    align-items: flex-start;
    justify-content: center;
    width: 100%;
    max-width: 1300px;
    margin: 0 auto;
    padding-inline: 10px;
  }
  .chart-container { flex: 0 0 33%; max-width: 420px; width: 100%; }
  .chart-card{
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 16px;
    box-shadow: var(--shadow);
    padding: 10px 10px 6px;
  }
  .chart-scroll { width: 100%; overflow-x: auto; overflow-y: hidden; }
  .chart-scroll canvas { display: block; }
  .chart-container canvas { height: 360px !important; }

  /* Zona de tablas/extra stats ocupa el resto */
  #extraStats { flex: 1 1 auto; min-width: 300px; }

  /* Grid de afinidades (dos columnas) */
  .affinity-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin-top: 18px;
  }
  .affinity-wrap{ text-align: center; }
  .affinity-wrap table{ margin-left: auto; margin-right: auto; max-width: 720px; }

  /* Responsive */
  @media (max-width: 900px) {
    .stats-layout { flex-direction: column; align-items: stretch; }
    .chart-container { flex: none; width: 100%; max-width: 640px; margin: 0 auto; }
    .affinity-grid{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Capas de pétalos -->
<div class="sakura-layer"></div>
<div class="sakura-layer2"></div>

<!-- Pantalla de inicio -->
<div id="start-screen">
  <div style="text-align:center">
    <h1>Japontinder</h1>
    <p>¿Quién eres? O no empezamos ò_ó</p>
    <input type="text" id="username" placeholder="Tu nombre" />
    <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="btn btn-yes" onclick="goToMode()">Continuar</button>
      <button class="btn btn-stats" onclick="showStats()">Ver estadísticas</button>
    </div>
  </div>
</div>

<!-- Selección de modo -->
<div id="mode-screen">
  <div style="text-align:center; margin-bottom:8px;">
    <h2>Elige modo de juego</h2>
    <p class="muted">Puedes cambiar cuando quieras volviendo al inicio.</p>
  </div>
  <div class="mode-grid">
    <div class="mode-card">
      <h3>Versión Corta</h3>
      <p>20 tarjetas al azar. Máx. <b>5</b> “Me da igual”.</p>
      <button class="btn btn-meh" onclick="startGame('short')">Jugar versión corta</button>
    </div>
    <div class="mode-card">
      <h3>Completo</h3>
      <p>Todas las tarjetas, orden aleatorio. Máx. <b>10</b> “Me da igual”.</p>
      <button class="btn btn-yes" onclick="startGame('full')">Jugar versión completa</button>
    </div>
  </div>
  <div style="margin-top:14px; text-align:center;">
    <button class="btn btn-ghost" onclick="goToStart()">Volver</button>
  </div>
</div>

<!-- Juego -->
<div id="game-screen" style="display:none; flex-direction: column; align-items: center;">
  <div id="card-container"></div>
  <div id="buttons">
    <button class="btn btn-no"  onclick="handleDecision(-1)">Pasando</button>
    <button class="btn btn-meh" onclick="handleDecision(0)">Me da igual</button>
    <button class="btn btn-yes" onclick="handleDecision(1)">Aquí sí</button>
  </div>
</div>

<!-- Resultados -->
<div id="results">
  <h2>Resultados</h2>
  <p id="player-info"></p>
  <div class="results-container">
    <div class="list">
      <h3>Aquí sí</h3>
      <ul id="accepted-list"></ul>
    </div>
    <div class="list">
      <h3>Me da igual</h3>
      <ul id="meh-list"></ul>
    </div>
    <div class="list">
      <h3>Pasando</h3>
      <ul id="rejected-list"></ul>
    </div>
  </div>
  <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <button class="btn btn-stats" onclick="showStats()">Ver estadísticas</button>
    <button class="btn btn-no" onclick="restartGame()">Volver al inicio</button>
  </div>
</div>

<!-- Pantalla de estadísticas -->
<div id="stats-screen">
  <h2>Estadísticas globales</h2>
  <div class="stats-layout">
    <div class="chart-container">
      <div class="chart-card">
        <div class="chart-scroll">
          <canvas id="statsChart"></canvas>
        </div>
      </div>
    </div>
    <div id="extraStats"></div>
  </div>
  <div style="margin-top:14px;">
    <button class="btn btn-no" onclick="goToStart()">Volver</button>
  </div>
</div>

<script>
  /* ===== Config remota ===== */
  const saveEndpoint = "https://japotinder.vercel.app/api/save";
  const dataUrl = "https://raw.githubusercontent.com/Syarapi/japotinder/main/results/data.json";

  /* ===== Paleta aleatoria para fondos/elementos (no afecta a botones/series) ===== */
  const PALETTE = ["var(--sakura)", "var(--lav)", "var(--sky)", "var(--sun)", "var(--mint)"];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function val(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim() || v; }
  function randomizeTheme() {
    const solid = val(pick(PALETTE));
    document.documentElement.style.setProperty('--bg-solid', solid);
    document.documentElement.style.setProperty('--card-border', val(pick(PALETTE)));
    document.documentElement.style.setProperty('--table-head-from', val(pick(PALETTE)));
    document.documentElement.style.setProperty('--table-head-to',   val(pick(PALETTE)));
  }
  randomizeTheme();

  /* ===== Datos ===== */
  let playerName = "";
  let gameMode = "full";  // 'short' | 'full'
  const originalData = [
    { name: "Disney Tokyo", img: "img/disney.jpg" },
    { name: "Gotokuji", img: "img/gotokuji.jpg" },
    { name: "Pokemon Cafe", img: "img/pokemon.jpg" },
    { name: "Shikisai no oka", img: "img/shikisai.jpg" },
    { name: "Shinkansen Hello Kitty", img: "img/hello-kitty.jpg" },
    { name: "Maid cafe", img: "img/maid.jpg" },
    { name: "Nabana no sato", img: "img/nabana.jpg" },
    { name: "Otaru", img: "img/otaru.jpg" },
    { name: "Nagano y monos de nieve", img: "img/nagano.jpg" },
    { name: "RJ Cafe Osaka", img: "img/rj-cafe.jpg" },
    { name: "Kumachan Onsen Tokyo", img: "img/kumachan.jpg" },
    { name: "Enoshima", img: "img/enoshima.jpg" },
    { name: "Ginzan Onsen", img: "img/ginzan.jpg" },
    { name: "Tarde de recreativas", img: "img/arcade.jpg" },
    { name: "Shibazakura park Hokkaido", img: "img/shibazakura.jpg" },
    { name: "Musical Tokyo Revengers", img: "img/tokyo-revengers.jpg" },
    { name: "Eventos Kisekoi/Sailor Moon", img: "img/kisekoi.jpg" },
    { name: "Museo/cafe de los yokai", img: "img/yokai.jpg" },
    { name: "Kumamoto", img: "img/kumamoto.jpg" },
    { name: "Beppu", img: "img/beppu.jpg" },
    { name: "Bandai Museum", img: "img/bandai.jpg" }
  ];
  let data = [];
  let accepted = [];
  let meh = [];
  let rejected = [];
  let index = 0;
  let mehLimit = 10; // default full
  const container = document.getElementById('card-container');

  function shuffleArray(array) { return array.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

  /* ===== Colores por jugador (fijos) ===== */
  const playerFixedColors = {}; // nombre -> color
  function getNameColor(name){
    const n = (name || "").trim().toLowerCase();
    if(n === "alba")   return "#2f7bdc";        // azul
    if(n === "alicia" || n === "vaini") return "#8a5adf"; // morado
    if(n === "sara")   return "#ff6fa1";        // rosa
    if(playerFixedColors[n]) return playerFixedColors[n];
    const candidates = ["#FFE480", "#A8E6CF"]; // sun legible o mint
    let hash = 0; for(let i=0;i<n.length;i++){ hash = (hash*31 + n.charCodeAt(i))|0; }
    const chosen = candidates[Math.abs(hash)%candidates.length];
    playerFixedColors[n] = chosen;
    return chosen;
  }

  /* ===== Flujo de pantallas ===== */
  document.getElementById("start-screen").style.display = "flex";

  function goToMode(){
    const nameInput = document.getElementById("username").value.trim();
    if (!nameInput) { alert("Que me digas quién eres o no jugamos ù3ú"); return; }
    playerName = nameInput;
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("mode-screen").style.display = "flex";
  }
  function goToStart() {
    document.getElementById("stats-screen").style.display = "none";
    document.getElementById("mode-screen").style.display = "none";
    document.getElementById("results").style.display = "none";
    document.getElementById("start-screen").style.display = "flex";
    randomizeTheme(); // refresca colores al volver
  }
  function restartGame() {
    document.getElementById("results").style.display = "none";
    document.getElementById("start-screen").style.display = "flex";
    randomizeTheme();
  }

  function startGame(mode='full') {
    gameMode = mode;
    data = shuffleArray([...originalData]);
    if(mode === 'short') data = data.slice(0, 20);
    mehLimit = (mode === 'short') ? 5 : 10;

    index = 0; accepted = []; meh = []; rejected = [];
    container.innerHTML = "";

    document.getElementById("mode-screen").style.display = "none";
    document.getElementById("game-screen").style.display = "flex";
    showNextCard();
  }

  /* ===== Lógica de tarjetas ===== */
  function createCard(person) {
    container.innerHTML = ""; // asegura solo 1 tarjeta visible
    const card = document.createElement('div'); card.className = 'card';
    const img = document.createElement('img'); img.src = person.img; img.alt = person.name;
    const name = document.createElement('div'); name.textContent = person.name;
    card.appendChild(img); card.appendChild(name); container.appendChild(card);
  }

  function swipeCard(direction) {
    const currentCard = container.querySelector('.card:last-child');
    if (!currentCard) return;
    const name = currentCard.querySelector('div').textContent;

    if (direction === 1) { accepted.push(name); }
    else if (direction === 0) {
      if (meh.length >= mehLimit) { alert("Por favor, mójate un poco más..."); return; }
      meh.push(name);
    }
    else { rejected.push(name); }

    showNextCard();
  }

  function handleDecision(direction) { swipeCard(direction); }

  function showNextCard() {
    if (index < data.length) { createCard(data[index]); index++; }
    else { showResults(); }
  }

  function setPlayerInfo(dateTime){
    const spanColor = getNameColor(playerName);
    const html = `Jugador: <span style="font-weight:700; color:${spanColor}">${playerName}</span> | ${dateTime} | Modo: ${gameMode === 'short' ? 'Corto' : 'Completo'}`;
    document.getElementById('player-info').innerHTML = html;
  }

  async function showResults() {
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('results').style.display = 'flex';
    const now = new Date(); const dateTime = now.toLocaleString();
    setPlayerInfo(dateTime);

    const acceptedList = document.getElementById('accepted-list');
    const mehList = document.getElementById('meh-list');
    const rejectedList = document.getElementById('rejected-list');
    acceptedList.innerHTML = ""; mehList.innerHTML = ""; rejectedList.innerHTML = "";

    accepted.forEach(n => { const li = document.createElement('li'); li.textContent = n; acceptedList.appendChild(li); });
    meh.forEach(n => { const li = document.createElement('li'); li.textContent = n; mehList.appendChild(li); });
    rejected.forEach(n => { const li = document.createElement('li'); li.textContent = n; rejectedList.appendChild(li); });

    try {
      await fetch(saveEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player: playerName, mode: gameMode, date: dateTime, accepted, meh, rejected })
      });
    } catch (e) {
      console.warn("No se pudo guardar en la API:", e);
    }
  }

  /* ===== Estadísticas ===== */
  let statsChartInstance = null;

  function ensureArray(maybeArray) {
    if (Array.isArray(maybeArray)) return maybeArray;
    if (maybeArray && Array.isArray(maybeArray.games)) return maybeArray.games;
    return [];
  }

  function destroyChart() {
    if (statsChartInstance) { statsChartInstance.destroy(); statsChartInstance = null; }
  }

  function gradient(ctx, colorTop, colorBot, h){
    const g = ctx.createLinearGradient(0, 0, 0, h);
    g.addColorStop(0, colorTop);
    g.addColorStop(1, colorBot);
    return g;
  }

  async function showStats() {
    // Pantallas
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('mode-screen').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('stats-screen').style.display = 'flex';

    const extraStats = document.getElementById('extraStats');
    extraStats.innerHTML = `<p class="muted">Cargando datos...</p>`;

    // Carga datos
    let games = [];
    try {
      const res = await fetch(`${dataUrl}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      games = ensureArray(json);
    } catch (err) {
      extraStats.innerHTML = `<p class="error">No se pudo cargar <code>results/data.json</code>. Detalle: ${err.message}</p>`;
      destroyChart();
      return;
    }
    if (!games.length) {
      extraStats.innerHTML = `<p class="notice">No hay partidas guardadas aún.</p>`;
      destroyChart();
      return;
    }

    // Normaliza (algunos registros antiguos pueden no tener "meh")
    const safeGames = games
      .filter(g => g && Array.isArray(g.accepted) && Array.isArray(g.rejected))
      .map(g => ({
        player: g.player || "¿anon?",
        accepted: g.accepted || [],
        meh: Array.isArray(g.meh) ? g.meh : [],
        rejected: g.rejected || []
      }));

    // Conteo por tarjeta (sí/meh/no)
    const stats = {};
    safeGames.forEach(g => {
      g.accepted.forEach(a => { stats[a] = stats[a] || { yes:0, meh:0, no:0 }; stats[a].yes++; });
      g.meh.forEach(m => { stats[m] = stats[m] || { yes:0, meh:0, no:0 }; stats[m].meh++; });
      g.rejected.forEach(r => { stats[r] = stats[r] || { yes:0, meh:0, no:0 }; stats[r].no++; });
    });
    const labels = Object.keys(stats).sort();
    const yesData = labels.map(l => stats[l].yes);
    const mehData = labels.map(l => stats[l].meh);
    const noData  = labels.map(l => stats[l].no);

    // Canvas ancho (scroll horizontal)
    const canvas = document.getElementById('statsChart');
    const desiredWidth = Math.max(labels.length * 50, 500);
    canvas.width = desiredWidth;
    canvas.height = 360;

    const ctx = canvas.getContext('2d');
    const gradYes = gradient(ctx, "#9ad6f7", "#5bb4e9", canvas.height); // azul
    const gradMeh = gradient(ctx, "#c8b8f2", "#9f89d0", canvas.height); // morado
    const gradNo  = gradient(ctx, "#ffc0cf", "#ff91aa", canvas.height); // rosa

    destroyChart();
    statsChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Aquí sí', data: yesData, backgroundColor: gradYes, borderRadius: 8 },
          { label: 'Me da igual', data: mehData, backgroundColor: gradMeh, borderRadius: 8 },
          { label: 'Pasando', data: noData,  backgroundColor: gradNo,  borderRadius: 8 }
        ]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { maxRotation: 60, minRotation: 0 } },
          y: { stacked: true, beginAtZero: true }
        },
        plugins: {
          legend: {
            labels: { color: '#3d2a68', boxWidth: 18, usePointStyle: true, pointStyle: 'rectRounded' }
          },
          tooltip: {
            backgroundColor: 'rgba(255,255,255,.95)',
            titleColor: '#5c2a4a',
            bodyColor: '#5c2a4a',
            borderColor: '#e8daf6',
            borderWidth: 1
          }
        },
        animation: { duration: 300 }
      }
    });

    // TOP 5 tarjetas por "sí"
    const topCards = Object.entries(stats)
      .sort((a, b) => b[1].yes - a[1].yes || a[0].localeCompare(b[0]))
      .slice(0, 5);

    // ===== Afinidad por coincidencia de tarjetas en "sí" =====
    // Mapa player -> Set(yes)
    const yesByPlayer = {};
    safeGames.forEach(g => { yesByPlayer[g.player] = new Set(g.accepted); });

    // Afinidad personal (coincidencias con el jugador actual por tarjetas)
    const myGame = safeGames.find(g => g.player === playerName);
    let affinityPersonal = [];
    if (myGame) {
      const myYes = new Set(myGame.accepted);
      const list = [];
      safeGames.forEach(g => {
        if (g.player !== playerName) {
          const commons = g.accepted.filter(x => myYes.has(x)); // tarjetas coincidentes
          list.push([g.player, commons.length, commons]);
        }
      });
      affinityPersonal = list
        .sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])))
        .slice(0, 5);
    }

    // Afinidad general: parejas con más tarjetas coincidentes en “sí”
    const players = Object.keys(yesByPlayer);
    const pairs = [];
    for(let i=0;i<players.length;i++){
      for(let j=i+1;j<players.length;j++){
        const p1 = players[i], p2 = players[j];
        const set1 = yesByPlayer[p1], set2 = yesByPlayer[p2];
        const commons = [...set1].filter(x => set2.has(x)); // tarjetas coincidentes
        if(commons.length>0){
          pairs.push([p1, p2, commons.length, commons]);
        }
      }
    }
    const affinityGeneral = pairs
      .sort((a,b)=> b[2]-a[2] || (a[0]+a[1]).localeCompare(b[0]+b[1]))
      .slice(0, 5);

    // Render (solo nombres)
    let html = "";
    html += "<h3>TOP 5 tarjetas con más 'sí'</h3>";
    html += "<table><tr><th>Tarjeta</th><th>Aquí sí</th><th>Meh</th><th>Pasando</th></tr>";
    topCards.forEach(([name, v]) => {
      html += `<tr><td>${name}</td><td>${v.yes}</td><td>${v.meh}</td><td>${v.no}</td></tr>`;
    });
    html += "</table>";

    // Grid doble de afinidades
    html += `<div class="affinity-grid">`;

    // Afinidad general (izquierda)
    html += `<div class="affinity-wrap">`;
    html += "<h3>TOP 5 afinidades generales (tarjetas coincidentes en 'sí')</h3>";
    html += "<table><tr><th>Jugadores</th><th>Coincidencias</th><th>Tarjetas coincidentes</th></tr>";
    if(affinityGeneral.length){
      affinityGeneral.forEach(([p1,p2,count, commons])=>{
        const c1 = getNameColor(p1), c2 = getNameColor(p2);
        const names = commons.join(", ");
        html += `<tr><td><span style="font-weight:600;color:${c1}">${p1}</span> &amp; <span style="font-weight:600;color:${c2}">${p2}</span></td><td>${count}</td><td>${names}</td></tr>`;
      });
    } else {
      html += `<tr><td colspan="3" class="muted">Aún no hay suficientes datos.</td></tr>`;
    }
    html += "</table>";
    html += `</div>`;

    // Afinidad personal (derecha)
    html += `<div class="affinity-wrap">`;
    html += `<h3>TOP 5 jugadores más afines contigo (tarjetas coincidentes en 'sí')</h3>`;
    html += "<table><tr><th>Jugador</th><th>Coincidencias</th><th>Tarjetas coincidentes</th></tr>";
    if (affinityPersonal.length){
      affinityPersonal.forEach(([p, s, commons]) => {
        const c = getNameColor(p);
        html += `<tr><td style="font-weight:600; color:${c}">${p}</td><td>${s}</td><td>${commons.join(", ")}</td></tr>`;
      });
    } else {
      html += `<tr><td colspan="3" class="muted">No hay datos de afinidad contigo todavía. Juega una partida para calcularla.</td></tr>`;
    }
    html += "</table>";
    html += `</div>`;

    html += `</div>`; // end affinity-grid

    extraStats.innerHTML = html;
  }
</script>
</body>
</html>
