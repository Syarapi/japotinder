<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Japotinder</title>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --yes:#87cefa;
    --meh:#8a5adf;
    --no:#ff7aa3;
    --ink:#333;
    --bg-light:#fff7fb; --bg-mid:#ffe3ef; --bg-dark:#d38cb1;
    --card-bg:#ffffffee;
    --accent-1:#FF91C0; --accent-2:#FF68A8;
    --petal-rgba: 255,182,193;
  }

  html, body { height: 100%; }
  body {
    margin: 0; font-family: 'Segoe UI', sans-serif; color: var(--ink);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center;
    background: var(--bg-light); position: relative; overflow-x: hidden;
  }

  /* Capa de kanji (fondo animado) */
  #kanji-layer{ position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
  .kanji-char{
    position: absolute; top: -12vh; transform: translateX(var(--x, 0)) translateY(0) rotate(var(--r, 0deg));
    font-family: 'Yuji Syuku', serif; color: rgba(var(--petal-rgba), var(--opa, .25));
    animation: fall-kanji var(--dur, 24s) linear infinite; user-select: none; white-space: pre; filter: blur(.2px);
  }
  .kanji-layer-a { --dur: 24s; --opa:.25; }
  .kanji-layer-b { --dur: 32s; --opa:.6;  }
  @keyframes fall-kanji{
    0%{transform: translateX(calc(var(--x,0) - 10px)) translateY(-12vh) rotate(calc(var(--r,0deg) - 10deg));}
    50%{transform: translateX(calc(var(--x,0) + 10px)) translateY(55vh)  rotate(calc(var(--r,0deg) + 10deg));}
    100%{transform: translateX(calc(var(--x,0) - 6px))  translateY(135vh) rotate(calc(var(--r,0deg) + 20deg));}
  }

  h1, h2, h3 { font-family: 'Yuji Syuku', serif; text-align: center; }
  h1 { color: var(--accent-1); text-shadow: 0 2px 0 #fff; margin: 10px 0 6px; }
  h2 { color: var(--accent-2); margin: 6px 0 10px; }

  /* Pantallas */
  #start-screen, #mode-screen, #game-screen, #results, #stats-screen {
    display: none; flex-direction: column; align-items: center; width: 100%; position: relative; z-index: 1;
  }
  #start-screen { display:flex; justify-content:center; gap:15px; min-height:100vh; padding: 16px 10px; }

  /* Tutorial (toggle) */
  .tutorial {
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    border-radius: 14px;
    width: min(92vw, 520px);
    box-shadow: 0 8px 18px rgba(0,0,0,.08);
    overflow: hidden;
  }
  .tutorial-header{
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 12px; cursor: pointer; user-select: none;
    background: linear-gradient(180deg, var(--accent-2), var(--accent-1));
    color: #fff;
  }
  .tutorial-title { margin: 0; font-size: 18px; width: 100%; text-align: center; }
  .tutorial-toggle {
    border: none; background: rgba(255,255,255,.2);
    padding: 6px 10px; border-radius: 10px; color: #fff; cursor: pointer;
    font-weight: 600;
  }
  .tutorial-body {
    padding: 10px 12px; text-align: left; font-size: 14px; background: var(--card-bg);
  }
  .tutorial ul { margin: 0; padding-left: 18px; }
  .tutorial li { margin: 6px 0; }

  /* Tarjetas */
  #game-screen{ padding-top: 40px; } /* más aire arriba */
  #card-container { position: relative; width: min(92%, 520px); height: min(70vh, 720px); display:flex; justify-content:center; align-items:center; }
  .card {
    position: relative; width: 100%; height: 100%; border-radius: 20px; overflow: hidden;
    border: 2px solid var(--accent-1); box-shadow: 0 10px 25px rgba(0,0,0,0.15); background:#fff;
  }
  .card img { width: 100%; height: 100%; object-fit: cover; display: block; user-select: none; -webkit-user-drag: none; }
  .card div { position: absolute; bottom:0; left:0; right:0; background: rgba(255,255,255,.85); color:var(--ink);
    font-weight:600; font-size: clamp(14px, 2vw, 16px); padding: 8px 12px; text-align:center; backdrop-filter: blur(4px); }

  /* Botones */
  #buttons { margin-top:10px; display:flex; gap:12px; z-index:10; }
  .btn { padding: 12px 18px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer;
         transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease; box-shadow: 0 8px 18px rgba(0,0,0,.12); color: white; }
  #btnNameNext, .stats-btn, .btn-primary { background: linear-gradient(180deg, var(--accent-1), var(--accent-2)); }
  .accept { background: linear-gradient(180deg, var(--yes), #5fb5ef); }
  .meh    { background: linear-gradient(180deg, var(--meh), #7343d8); }
  .reject { background: linear-gradient(180deg, var(--no), #ff5f93); }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.16); }
  .btn:active{ transform: translateY(0); opacity:.95; }

  /* Tablas y stats */
  table { border-collapse: collapse; margin-top: 10px; width: 100%; background: #fff;
    border-radius: 14px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border: 2px solid var(--accent-1); }
  th, td { padding: 8px 10px; border-bottom: 1px solid #f0e7f8; text-align: left; word-break: break-word; font-size: 13px; }
  th { background: linear-gradient(180deg, var(--accent-2), var(--accent-1)); color: #fff; letter-spacing:.3px; }
  tr:nth-child(even) { background-color: #faf7ff; }

  /* Modo: right tint (más oscuro) */
  .half.right { position: relative; }
  .half.right::before{
    content:""; position:absolute; inset:0;
    background: var(--bg-dark);
    opacity: .18; /* antes .07 */
    pointer-events: none; z-index: 0;
  }
  .half.right > .content { position: relative; z-index: 1; }

  /* Contenedor scroll del gráfico */
  .chart-scroll { overflow-x: auto; overflow-y: hidden; }
</style>
</head>
<body>
  <div id="kanji-layer" aria-hidden="true"></div>

  <!-- Inicio -->
  <div id="start-screen">
    <div style="text-align:center; width:100%; display:flex; flex-direction:column; align-items:center; gap:10px;">
      <h1>Japotinder</h1>

      <!-- TUTORIAL (toggle) -->
      <div class="tutorial" id="tutorial">
        <div class="tutorial-header" id="tutorialHeader" role="button" tabindex="0" aria-expanded="true" aria-controls="tutorialBody">
          <h3 class="tutorial-title">Tutorial</h3>
          <button class="tutorial-toggle" id="tutorialToggleBtn" type="button">Ocultar</button>
        </div>
        <div class="tutorial-body" id="tutorialBody">
          <ul>
            <li><strong>Swipe derecha</strong> → “Aquí sí”.</li>
            <li><strong>Swipe izquierda</strong> → “Pasando”.</li>
            <li><strong>Swipe hacia arriba</strong> → “Me da igual”.</li>
            <li>Si prefieres, usa los <strong>botones</strong> bajo la tarjeta: <em>Aquí sí / Me da igual / Pasando</em>.</li>
            <li>En <em>Modo corto</em> tienes <strong>5</strong> “Me da igual”; en <em>Modo completo</em>, <strong>10</strong>.</li>
          </ul>
        </div>
      </div>

      <p>¿Quién eres?</p>
      <input type="text" id="username" placeholder="Tu nombre" />
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <button class="btn btn-primary" id="btnNameNext">Siguiente</button>
        <button class="btn stats-btn" onclick="showStats()">Ver estadísticas</button>
      </div>
    </div>
  </div>

  <!-- Modo -->
  <div id="mode-screen" style="display:none; min-height: 100vh;">
    <div class="mode-split" style="display:grid; grid-template-columns:1fr 1fr; width:100%; min-height:100vh;">
      <div class="half left" id="halfShort" style="display:flex; align-items:center; justify-content:center; cursor:pointer; padding:20px;">
        <div class="content" style="text-align:center; max-width:520px; background: var(--card-bg); border:2px solid var(--accent-1); border-radius:16px; padding:18px;">
          <h2>Modo corto</h2>
          <p>20 tarjetas aleatorias. “Me da igual” 5 veces.</p>
        </div>
      </div>
      <div class="half right" id="halfFull" style="display:flex; align-items:center; justify-content:center; cursor:pointer; padding:20px;">
        <div class="content" style="text-align:center; max-width:520px; background: var(--card-bg); border:2px solid var(--accent-1); border-radius:16px; padding:18px;">
          <h2>Modo completo</h2>
          <p>Todas las tarjetas. “Me da igual” 10 veces.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Juego -->
  <div id="game-screen" style="display:none; flex-direction:column; align-items:center;">
    <div id="card-container"></div>
    <div id="buttons">
      <button class="btn reject" onclick="handleDecision(-1)">Pasando</button>
      <button class="btn meh"    onclick="handleDecision(0)">Me da igual</button>
      <button class="btn accept" onclick="handleDecision(1)">Aquí sí</button>
    </div>
  </div>

  <!-- Resultados -->
  <div id="results" style="display:none; align-items:center; padding:10px; width:100%; max-width:980px;">
    <h2>Resultados</h2>
    <p id="player-info" style="margin:4px 0 8px;"></p>
    <div class="results-table" style="width:100%;">
      <table>
        <thead><tr><th>Aquí sí</th><th>Me da igual</th><th>Pasando</th></tr></thead>
        <tbody id="results-body"></tbody>
      </table>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
      <button class="btn stats-btn" onclick="showStats()">Ver estadísticas</button>
      <button class="btn stats-btn" onclick="goToStart()">Volver</button>
    </div>
  </div>

  <!-- Stats -->
  <div id="stats-screen" style="display:none; min-height:100vh; padding: 6px 10px 10px; box-sizing: border-box; overflow-y:auto;">
    <h2>Estadísticas globales</h2>
    <div class="stats-grid" style="display:grid; grid-template-columns: minmax(340px, 1fr) minmax(420px, 1.2fr); gap:12px;">
      <div class="chart-card" style="background:var(--card-bg); border:2px solid var(--accent-1); border-radius:16px; padding:8px;">
        <div class="chart-scroll" style="max-height:360px; padding-bottom:6px;">
          <canvas id="statsChart"></canvas>
        </div>
      </div>
      <div class="top-card" style="background:var(--card-bg); border:2px solid var(--accent-1); border-radius:16px; padding:8px;">
        <h3 style="margin:4px 0 6px;">TOP tarjetas con más "sí"</h3>
        <div class="top-scroll" style="overflow-y:auto; max-height:220px; padding-bottom:6px;">
          <table id="topCardsTable">
            <thead><tr><th>Tarjeta</th><th>Sí</th><th>Meh</th><th>No</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="affinityArea" style="display:none; margin-top:12px; gap:12px; grid-template-columns:1fr 1fr;">
      <div class="aff-card" style="background:var(--card-bg); border:2px solid var(--accent-1); border-radius:16px; padding:8px;">
        <h3 style="margin:4px 0 6px;">Ranking de afinidad (todos)</h3>
        <div class="aff-scroll" style="overflow-y:auto; max-height:220px; padding-bottom:6px;">
          <table id="affinityGlobal">
            <thead><tr><th>Pareja</th><th>#</th><th>Tarjetas en común (SÍ)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="aff-card" style="background:var(--card-bg); border:2px solid var(--accent-1); border-radius:16px; padding:8px;">
        <h3 style="margin:4px 0 6px;">Jugadores más afines contigo</h3>
        <div class="aff-scroll" style="overflow-y:auto; max-height:220px; padding-bottom:6px;">
          <table id="affinityPersonal">
            <thead><tr><th>Jugador</th><th>#</th><th>Tarjetas en común (SÍ)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="margin-top:8px; display:flex; justify-content:center;">
      <button class="btn stats-btn" onclick="goToStart()">Volver</button>
    </div>
  </div>

<script>
  /************ Config ************/
  const saveEndpoint = "/api/save";
  const dataUrl = "https://raw.githubusercontent.com/Syarapi/japotinder/main/results/data.json";
  const TUTORIAL_LS = "japotinder_tutorial_open_v1";

  /************ Datos base ************/
  const originalData = [
    { name: "Disney Tokyo", img: "img/disney.jpg" },
    { name: "Gotokuji", img: "img/gotokuji.jpg" },
    { name: "Pokemon Cafe", img: "img/pokemon.jpg" },
    { name: "Shikisai no oka", img: "img/shikisai.jpg" },
    { name: "Shinkansen Hello Kitty", img: "img/hello-kitty.jpg" },
    { name: "Maid cafe", img: "img/maid.jpg" },
    { name: "Nabana no sato", img: "img/nabana.jpg" },
    { name: "Otaru", img: "img/otaru.jpg" },
    { name: "Nagano y monos de nieve", img: "img/nagano.jpg" },
    { name: "RJ Cafe Osaka", img: "img/rj-cafe.jpg" },
    { name: "Kumachan Onsen Tokyo", img: "img/kumachan.jpg" },
    { name: "Enoshima", img: "img/enoshima.jpg" },
    { name: "Ginzan Onsen", img: "img/ginzan.jpg" },
    { name: "Tarde de recreativas", img: "img/arcade.jpg" },
    { name: "Shibazakura park Hokkaido", img: "img/shibazakura.jpg" },
    { name: "Musical Tokyo Revengers", img: "img/tokyo-revengers.jpg" },
    { name: "Eventos de mangas específicos", img: "img/kisekoi.jpg" },
    { name: "Museo/cafe de los yokai", img: "img/yokai.jpg" },
    { name: "Kumamoto", img: "img/kumamoto.jpg" },
    { name: "Beppu", img: "img/beppu.jpg" },
    { name: "Bandai Museum", img: "img/bandai.jpg" },
    { name: "Tanuki Dori", img: "img/tanuki.jpg" },
    { name: "Coleccionar Manhole cards", img: "img/manhole.jpg" },
    { name: "Entrar a Sekaido o Itoya (90 pisos de material de arte)", img: "img/sekaido.jpg" },
    { name: "Doraemon time square", img: "img/doraemon.jpg" },
    { name: "Shiroi Koibito Park", img: "img/shiroi-koibito.jpg" },
    { name: "2D Café Tokyo", img: "img/2dcafe.jpg" },
    { name: "Comer en Tofuro Ginza", img: "img/tofuro.jpg" },
    { name: "Music box Museum", img: "img/musicbox.jpg" },
    { name: "Aitama Daibutsu (Buddha y moais)", img: "img/aitama.jpg" },
    { name: "Hakone", img: "img/hakone.jpg" },
    { name: "Nikko", img: "img/nikko.jpg" },
    { name: "Oarai Isosaki shrine", img: "img/oarai.jpg" },
    { name: "Dormir en Ryokan Ookawaso", img: "img/ookawaso.jpg" },
    { name: "Museo de Nintendo", img: "img/nintendo.jpg" },
    { name: "Dormir en Onyado Nono Kyoto", img: "img/onyado.jpg" },
    { name: "Katsuouji y postal de Darumas", img: "img/katsuouji.jpg" },
    { name: "Dormir en Toggle (cada habitación es de un único color completa)", img: "img/toggle.jpg" },
    { name: "Dormir en Henn na hotel", img: "img/hennna.jpg" },
    { name: "Probar los simulacros de terremotos", img: "img/terremoto.jpg" },
    { name: "Ir a ver sumo", img: "img/sumo.jpg" },
    { name: "Ir a ver kabuki", img: "img/kabuki.jpg" },
    { name: "Ushiku Daibutsu", img: "img/ushiku.jpg" },
    { name: "Tienda de Chopper", img: "img/mugiwara.jpg" },
  ];

  /************ Estado ************/
  let playerName = "";
  let mode = "short";
  let data = [];
  let accepted = [];
  let rejected = [];
  let meh = [];
  let index = 0;
  let mehLimit = 5;
  let statsChartInstance = null;
  const container = document.getElementById('card-container');

  /************ Utilidades ************/
  const shuffleArray = (array) => array.slice().sort(() => Math.random() - 0.5);

  const LS_KEY = "japotinder_player_colors_v3";
  function loadColorMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }catch{ return {}; } }
  function saveColorMap(map){ try{ localStorage.setItem(LS_KEY, JSON.stringify(map)); }catch{} }
  const COLOR_POOL = ["#2f7bdc","#8a5adf","#b398d6","#acd68a","#ff6fa1","#48d1cc","#ffd666","#56e0b5","#68cba7","#ffd8a3","#ffccb1","#c1ff71"];
  const RESERVED = { "alba":"#2f7bdc", "sara":"#ff6fa1", "alicia":"#8a5adf", "vaini":"#b398d6" };
  function hslColor(i){ const hue = (i * 47) % 360; return `hsl(${hue} 70% 55%)`; }
  function getPlayerColorUnique(name){
    const key = (name||"").trim().toLowerCase();
    let map = loadColorMap();
    if (map[key]) return map[key];
    if (RESERVED[key]) { const rc = RESERVED[key]; for (const n in map) if (map[n] === rc) delete map[n]; map[key]=rc; saveColorMap(map); return rc; }
    const used = new Set(Object.values(map)); Object.values(RESERVED).forEach(c=>used.add(c));
    for (const c of COLOR_POOL) if (!used.has(c)) { map[key]=c; saveColorMap(map); return c; }
    let i=0; while(true){ const c=hslColor(i++); if(!used.has(c)){ map[key]=c; saveColorMap(map); return c; } }
  }

  function destroyChart(){
    try { if (statsChartInstance && typeof statsChartInstance.destroy === 'function') statsChartInstance.destroy(); }
    catch(_){}
    statsChartInstance = null;
  }

  function ensureArray(maybeArray) {
    if (Array.isArray(maybeArray)) return maybeArray;
    if (maybeArray && Array.isArray(maybeArray.games)) return maybeArray.games;
    return [];
  }

  async function getSeenCardsForPlayer(name){
    const seen = new Set();
    try {
      const res = await fetch(`${dataUrl}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const games = ensureArray(await res.json());
      const latest = new Map();
      games
        .filter(g => g && g.player && g.player.trim().toLowerCase() === name.trim().toLowerCase())
        .forEach(g => {
          const ts = Date.parse(g.date || g.timestamp || "") || 0;
          const add = (card) => {
            const prev = latest.get(card);
            if (!prev || ts >= prev) latest.set(card, ts);
          };
          (g.accepted||[]).forEach(add);
          (g.meh||[]).forEach(add);
          (g.rejected||[]).forEach(add);
        });
      latest.forEach((_ts, card)=>seen.add(card));
    } catch(e){ console.warn("No se pudo cargar partidas previas:", e); }
    return seen;
  }

  /* ===== Tema + Kanji ===== */
  function applyRandomTheme(){
    const themes = [
      { light:"#fff7fb", mid:"#ffe3ef", dark:"#d38cb1", accent1:"#FF91C0", accent2:"#FF68A8", petal:[220,120,160] },
      { light:"#f2f9ff", mid:"#e0f1ff", dark:"#8dbfe6", accent1:"#a3c9ff", accent2:"#7fb2f0", petal:[120,160,220] },
      { light:"#faf5ff", mid:"#efe3ff", dark:"#b48ad6", accent1:"#d7a6f1", accent2:"#b48ad6", petal:[150,110,200] },
      { light:"#e9fff8", mid:"#d1fff0", dark:"#68cba7", accent1:"#9fe6cc", accent2:"#68cba7", petal:[90,170,140] },
      { light:"#ffeceb", mid:"#ffb3b0", dark:"#b94a48", accent1:"#f28b82", accent2:"#e57373", petal:[242,139,130] },
    ];
    const pick = themes[Math.floor(Math.random()*themes.length)];
    const root = document.documentElement.style;
    root.setProperty('--bg-light', pick.light);
    root.setProperty('--bg-mid', pick.mid);
    root.setProperty('--bg-dark', pick.dark);
    root.setProperty('--accent-1', pick.accent1);
    root.setProperty('--accent-2', pick.accent2);
    const pet = Array.isArray(pick.petal) && pick.petal.length === 3 ? pick.petal : [220,120,160];
    root.setProperty('--petal-rgba', `${pet[0]},${pet[1]},${pet[2]}`);
    spawnKanji();
  }

  const KANJI = "日月火水木金土山川田人口女子学校先生時間東京日本大中小上下左右入口出口駅車電気食飲見行来会話読書映画音楽花愛友幸楽海空風雨雪猫犬鳥龍心星春夏秋冬夢道神寺社桜光美和新古旅食買飲遊語学写真";
  function spawnKanji(){
    const layer = document.getElementById('kanji-layer');
    layer.innerHTML = "";
    const pick = () => KANJI[Math.floor(Math.random() * KANJI.length)];
    const makeChar = (layerClass) => {
      const el = document.createElement('span');
      el.className = `kanji-char ${layerClass}`;
      el.textContent = pick();
      const vw = Math.random() * 100;
      const size = 14 + Math.random() * 18;
      const rot = (Math.random() * 60 - 30) + "deg";
      const delay = (-Math.random() * 32).toFixed(2) + "s";
      el.style.setProperty('--x', vw + 'vw');
      el.style.setProperty('--r', rot);
      el.style.fontSize = size + 'px';
      el.style.animationDelay = delay;
      layer.appendChild(el);
    };
    for (let i=0;i<40;i++) makeChar('kanji-layer-a');
    for (let i=0;i<40;i++) makeChar('kanji-layer-b');
  }

  function setPlayerInfo(dateTime){
    const spanColor = getPlayerColorUnique(playerName);
    const html = `Jugador: <span style="font-weight:700; color:${spanColor}">${playerName}</span> | ${dateTime} | Modo: ${mode === 'short' ? 'Corto' : 'Completo'}`;
    document.getElementById('player-info').innerHTML = html;
  }

  /************ Tutorial: toggle + persistencia ************/
  function initTutorialToggle(){
    const header = document.getElementById('tutorialHeader');
    const btn = document.getElementById('tutorialToggleBtn');
    const body = document.getElementById('tutorialBody');

    const setOpen = (open) => {
      body.style.display = open ? 'block' : 'none';
      header.setAttribute('aria-expanded', String(open));
      btn.textContent = open ? 'Ocultar' : 'Mostrar';
      try{ localStorage.setItem(TUTORIAL_LS, JSON.stringify(!!open)); }catch{}
    };

    // Estado inicial desde LS (por defecto: abierto)
    let open = true;
    try {
      const raw = localStorage.getItem(TUTORIAL_LS);
      if (raw !== null) open = JSON.parse(raw) === true;
    } catch(_) {}
    setOpen(open);

    const toggle = () => setOpen(!(body.style.display !== 'none'));
    header.addEventListener('click', toggle);
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
    header.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }});
  }

  /************ Flujo UI ************/
  document.getElementById("btnNameNext").addEventListener("click", () => {
    const nameInput = document.getElementById("username").value.trim();
    if (!nameInput) { alert("Que me digas quién eres o no jugamos ù3ú"); return; }
    playerName = nameInput;
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("mode-screen").style.display = "flex";
  });

  document.getElementById("halfShort").addEventListener("click", () => { mode = "short"; mehLimit = 5; startGameWithMode(); });
  document.getElementById("halfFull").addEventListener("click", () => { mode = "full";  mehLimit = 10; startGameWithMode(); });

  async function startGameWithMode() {
    const SHORT_COUNT = 20;
    let safeOriginal = [...originalData];
    if (mode === "short") {
      let availableCards = safeOriginal;
      if (playerName) {
        const seen = await getSeenCardsForPlayer(playerName);
        availableCards = safeOriginal.filter(c => !seen.has(c.name));
      }
      if (availableCards.length < SHORT_COUNT) availableCards = shuffleArray(safeOriginal);
      else availableCards = shuffleArray(availableCards);
      data = availableCards.slice(0, SHORT_COUNT);
    } else {
      data = shuffleArray(safeOriginal);
    }
    index = 0; accepted = []; rejected = []; meh = [];
    container.innerHTML = "";
    document.getElementById("mode-screen").style.display = "none";
    document.getElementById("game-screen").style.display = "flex";
    showNextCard(true);
  }

  function createCard(item) {
    const card = document.createElement('div'); card.className = 'card';
    const img = document.createElement('img'); img.src = item.img; img.alt = item.name;
    const name = document.createElement('div'); name.textContent = item.name;
    card.appendChild(img); card.appendChild(name);
    attachSwipe(card);
    return card;
  }

  function showNextCard(initial=false) {
    if (!initial) container.innerHTML = "";
    if (index < data.length) {
      const card = createCard(data[index]);
      container.appendChild(card);
    } else {
      showResults();
    }
  }

  function attachSwipe(el){
    let startX=0, startY=0, dx=0, dy=0, active=false;
    const onStart = (x,y) => { active=true; startX=x; startY=y; dx=0; dy=0; el.style.transition=""; };
    const onMove = (x,y) => {
      if(!active) return;
      dx = x - startX; dy = y - startY;
      const rot = dx * 0.05;
      el.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
      el.style.opacity = String(1 - Math.min(0.6, Math.abs(dx)/300 + Math.max(0, -dy)/300));
    };
    const onEnd = () => {
      if(!active) return; active=false;
      const THX = 80, THY = -80;
      if (dx <= -THX) { commitDecision(-1); return; }
      if (dx >=  THX) { commitDecision( 1); return; }
      if (dy <=  THY) { commitDecision( 0); return; }
      el.style.transition="transform .2s ease, opacity .2s ease";
      el.style.transform="translate(0,0) rotate(0)"; el.style.opacity="1";
    };
    el.addEventListener("touchstart", (e)=>onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
    el.addEventListener("touchmove",  (e)=>onMove(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
    el.addEventListener("touchend",   onEnd);
    el.addEventListener("mousedown", (e)=>onStart(e.clientX, e.clientY));
    window.addEventListener("mousemove", (e)=>onMove(e.clientX, e.clientY));
    window.addEventListener("mouseup", onEnd);
  }

  function commitDecision(direction){
    const el = container.querySelector('.card');
    if (!el) return;
    const name = el.querySelector('div').textContent;
    if (direction === 1) accepted.push(name);
    else if (direction === -1) rejected.push(name);
    else {
      if (meh.length >= mehLimit) {
        alert("Por favor, mójate un poco más…");
        el.style.transition="transform .2s ease, opacity .2s ease";
        el.style.transform="translate(0,0) rotate(0)"; el.style.opacity="1";
        return;
      }
      meh.push(name);
    }
    index++; container.innerHTML = ""; showNextCard();
  }

  function handleDecision(direction){ commitDecision(direction); }
  window.handleDecision = handleDecision;

  /************ Resultados + guardado ************/
  function buildResultsTableRows(a, m, r){
    const maxRows = Math.max(a.length, m.length, r.length);
    const rows = [];
    for (let i=0;i<maxRows;i++){
      rows.push(`<tr><td>${a[i]||""}</td><td>${m[i]||""}</td><td>${r[i]||""}</td></tr>`);
    }
    return rows.join("");
  }

  async function showResults() {
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('results').style.display = 'flex';
    const now = new Date(); const dateTime = now.toLocaleString();
    setPlayerInfo(dateTime);
    document.getElementById('results-body').innerHTML = buildResultsTableRows(accepted, meh, rejected);
    try {
      await fetch(saveEndpoint, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player: playerName, date: dateTime, mode, accepted, meh, rejected })
      });
    } catch (e) { console.warn("No se pudo guardar en la API:", e); }
  }

  /************ Estadísticas ************/
  async function showStats() {
    // Ocultar vistas
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('mode-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('stats-screen').style.display = 'block';

    const topBodyEl = document.querySelector('#topCardsTable tbody');
    const affGlobalBodyEl   = document.querySelector('#affinityGlobal tbody');
    const affPersonalBodyEl = document.querySelector('#affinityPersonal tbody');
    topBodyEl.innerHTML = ""; affGlobalBodyEl.innerHTML = ""; affPersonalBodyEl.innerHTML = "";
    document.getElementById('affinityArea').style.display = "none";

    let games = [];
    try {
      const res = await fetch(`${dataUrl}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      games = ensureArray(await res.json());
    } catch (err) {
      alert("No se pudo cargar results/data.json: " + err.message);
      destroyChart();
      return;
    }
    if (!games.length) { destroyChart(); return; }

    const safeGames = games
      .filter(g => g && (Array.isArray(g.accepted) || Array.isArray(g.rejected) || Array.isArray(g.meh)))
      .map(g => ({
        player: (g.player || "¿anon?").trim(),
        accepted: Array.isArray(g.accepted) ? g.accepted : [],
        meh: Array.isArray(g.meh) ? g.meh : [],
        rejected: Array.isArray(g.rejected) ? g.rejected : [],
        ts: Date.parse(g.date || g.timestamp || "") || 0
      }));

    const latest = {};
    for (const g of safeGames) {
      const p = g.player;
      if (!latest[p]) latest[p] = {};
      const up = (card, choice) => {
        const prev = latest[p][card];
        if (!prev || g.ts >= prev.ts) latest[p][card] = { choice, ts: g.ts };
      };
      g.accepted.forEach(c => up(c, 'yes'));
      g.meh.forEach(c      => up(c, 'meh'));
      g.rejected.forEach(c => up(c, 'no'));
    }

    const stats = {};
    for (const p in latest) {
      for (const card in latest[p]) {
        const ch = latest[p][card].choice;
        if (!stats[card]) stats[card] = { yes:0, meh:0, no:0 };
        stats[card][ch] += 1;
      }
    }

    const labels  = Object.keys(stats).sort((a,b)=>a.localeCompare(b));
    const yesData = labels.map(l => stats[l].yes);
    const mehData = labels.map(l => stats[l].meh);
    const noData  = labels.map(l => stats[l].no);

    const canvas = document.getElementById('statsChart');
    // Mantengo el ancho por etiqueta para que quepan los nombres, pero estrecho las barras
    const desiredWidth = Math.max(labels.length * 80, 640);
    canvas.width = desiredWidth; canvas.height = 360;
    const ctx = canvas.getContext('2d');

    const css = getComputedStyle(document.documentElement);
    const grad = (hex) => { const g = ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,hex); g.addColorStop(1,hex); return g; };

    destroyChart();
    if (typeof Chart === 'function') {
      statsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Aquí sí',     data: yesData, backgroundColor: grad(css.getPropertyValue('--yes').trim()), borderRadius: 8, stack: 'stack', barPercentage: 0.9, categoryPercentage: 0.5, maxBarThickness: 42 },
            { label: 'Me da igual', data: mehData, backgroundColor: grad(css.getPropertyValue('--meh').trim()), borderRadius: 8, stack: 'stack', barPercentage: 0.9, categoryPercentage: 0.5, maxBarThickness: 42 },
            { label: 'Pasando',     data: noData,  backgroundColor: grad(css.getPropertyValue('--no').trim()),  borderRadius: 8, stack: 'stack', barPercentage: 0.9, categoryPercentage: 0.5, maxBarThickness: 42 }
          ]
        },
        options: {
          responsive: false, maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: { autoSkip: false, maxRotation: 70, minRotation: 45 }
            },
            y: { stacked: true, beginAtZero: true }
          },
          plugins: {
            legend: { labels: { color: '#333', boxWidth: 18, usePointStyle: true, pointStyle: 'rectRounded' } },
            tooltip: { backgroundColor: 'rgba(255,255,255,.95)', titleColor: '#333', bodyColor: '#333', borderColor: '#ddd', borderWidth: 1 }
          },
          animation: { duration: 220 }
        }
      });
    }

    // TOP tarjetas
    const topCards = Object.entries(stats).sort((a,b) => b[1].yes - a[1].yes || a[0].localeCompare(b[0]));
    for (const [name, v] of topCards) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${v.yes}</td><td>${v.meh}</td><td>${v.no}</td>`;
      topBodyEl.appendChild(tr);
    }

    // Afinidades
    const byPlayer = {};
    for (const p in latest) {
      const set = new Set();
      for (const card in latest[p]) if (latest[p][card].choice === 'yes') set.add(card);
      if (set.size) byPlayer[p] = set;
    }
    const players = Object.keys(byPlayer).sort((a,b)=>a.localeCompare(b));

    const pairs = [];
    for (let i=0;i<players.length;i++){
      for (let j=i+1;j<players.length;j++){
        const p1 = players[i], p2 = players[j];
        const s1 = byPlayer[p1], s2 = byPlayer[p2];
        const inter = []; s1.forEach(x => { if (s2.has(x)) inter.push(x); });
        if (inter.length) pairs.push({ a:p1, b:p2, common:inter.sort(), count:inter.length });
      }
    }
    pairs.sort((x,y)=> y.count - x.count || (x.a+x.b).localeCompare(y.a+y.b));

    pairs.slice(0, 200).forEach(row=>{
      const cA = getPlayerColorUnique(row.a);
      const cB = getPlayerColorUnique(row.b);
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td><span style="font-weight:600;color:${cA}">${row.a}</span> &amp; ` +
        `<span style="font-weight:600;color:${cB}">${row.b}</span></td>` +
        `<td>${row.count}</td>` +
        `<td class="cards-small">${row.common.join(", ")}</td>`;
      affGlobalBodyEl.appendChild(tr);
    });

    let personalRows = [];
    if (playerName && byPlayer[playerName]) {
      const mine = byPlayer[playerName];
      players.filter(p=>p!==playerName).forEach(p=>{
        const inter = []; byPlayer[p].forEach(x=>{ if (mine.has(x)) inter.push(x); });
        if (inter.length) personalRows.push({ player:p, count:inter.length, list:inter.sort() });
      });
      personalRows.sort((x,y)=> y.count - x.count || x.player.localeCompare(y.player));
    }
    if (personalRows.length){
      personalRows.slice(0,200).forEach(r=>{
        const c = getPlayerColorUnique(r.player);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="font-weight:600; color:${c}">${r.player}</td><td>${r.count}</td><td class="cards-small">${r.list.join(", ")}</td>`;
        affPersonalBodyEl.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3"><span class="notice">Juega una partida para ver tu afinidad personal.</span></td>`;
      affPersonalBodyEl.appendChild(tr);
    }
    document.getElementById('affinityArea').style.display = "grid";
  }
  window.showStats = showStats;

  function goToStart(){
    destroyChart();
    document.getElementById('stats-screen').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('mode-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
  }
  window.goToStart = goToStart;

  /************ Init ************/
  applyRandomTheme();
  initTutorialToggle();
  document.getElementById("start-screen").style.display = "flex";
</script>
</body>
</html>
