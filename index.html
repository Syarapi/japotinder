<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  /* ======= CSS que me pasaste ======= */
  :root{
    /* Paleta fija para botones/series (NO aleatoria) */
    --yes:#87cefa;
    --meh:#8a5adf;
    --no:#ff7aa3;
    /* Variables de tema aleatorio */
    --ink:#333;
    --bg-light:#fff7fb;
    --bg-mid:#ffe3ef;
    --bg-dark:#d38cb1;
    --card-bg:#ffffffee;
    --accent-1:#FF91C0;
    --accent-2:#FF68A8;
    --petal-rgba: 255,182,193;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    color: var(--ink);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--bg-light);
    position: relative;
    overflow-x: hidden;
  }
  body::before, body::after{ content: none !important; }
  .kanji-char{
    position: fixed;
    top: -12vh;
    left: 0;
    transform: translateX(var(--x, 0)) translateY(0) rotate(var(--r, 0deg));
    font-family: 'Yuji Syuku', serif;
    pointer-events: none;
    user-select: none;
    z-index: -1;
    color: rgba(var(--petal-rgba), var(--opa, .25));
    animation: fall-kanji var(--dur, 24s) linear infinite;
    filter: blur(0.2px);
  }
  .kanji-layer-a { --dur: 24s; --opa:.25; }
  .kanji-layer-b { --dur: 32s; --opa:.6;  }
  @keyframes fall-kanji{
    0%   { transform: translateX(calc(var(--x, 0) - 10px)) translateY(-12vh) rotate(calc(var(--r, 0deg) - 10deg)); }
    50%  { transform: translateX(calc(var(--x, 0) + 10px)) translateY(55vh)  rotate(calc(var(--r, 0deg) + 10deg)); }
    100% { transform: translateX(calc(var(--x, 0) - 6px))  translateY(135vh) rotate(calc(var(--r, 0deg) + 20deg)); }
  }
  h1, h2, h3 { font-family: 'Yuji Syuku', serif; text-align: center; }
  h1 { color: var(--accent-1); text-shadow: 0 2px 0 #fff; margin: 10px 0 6px; }
  h2 { color: var(--accent-2); margin: 6px 0 10px; }
  h3 { color: var(--accent-1); margin: 10px 0; }
  /* Pantallas */
  #start-screen, #mode-screen, #game-screen, #results, #stats-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  #start-screen { display: flex; justify-content: center; gap: 15px; min-height: 100vh; padding: 16px 10px; }
  /* Tarjetas */
  #card-container {
    position: relative;
    width: min(92%, 520px);
    height: min(70vh, 720px);
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 20px;
    overflow: hidden;
    border: 2px solid var(--accent-1);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    will-change: transform;
  }
  .card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    user-select: none;
    -webkit-user-drag: none;
  }
  .card div {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.85);
    color: var(--ink);
    font-weight: 600;
    font-size: clamp(14px, 2vw, 16px);
    padding: 8px 12px;
    text-align: center;
    backdrop-filter: blur(4px);
  }
  /* Botones */
  #buttons {
    margin-top: 10px;
    display: flex;
    gap: 12px;
    z-index: 10;
  }
  .btn {
    padding: 12px 18px;
    font-size: 16px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.12);
    color: white;
  }
  #btnNameNext, .stats-btn { background: linear-gradient(180deg, var(--accent-1) 0%, var(--accent-2) 100%); color: #fff; }
  .accept { background: linear-gradient(180deg, var(--yes) 0%, #5fb5ef 100%); }
  .meh    { background: linear-gradient(180deg, var(--meh) 0%, #7343d8 100%); }
  .reject { background: linear-gradient(180deg, var(--no) 0%, #ff5f93 100%); }
  .stats-btn { background: linear-gradient(180deg, var(--accent-1) 0%, var(--accent-2) 100%); color: #fff; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.16); }
  .btn:active { transform: translateY(0); opacity:.95; }
  /* Tablas */
  table {
    border-collapse: collapse;
    margin-top: 10px;
    width: 100%;
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border: 2px solid var(--accent-1);
    table-layout: auto;
  }
  table th, table td {
    padding: 8px 10px;
    border-bottom: 1px solid #f0e7f8;
    text-align: left;
    word-break: break-word;
  }
  table th {
    background: linear-gradient(180deg, var(--accent-2) 0%, var(--accent-1) 100%);
    color: white;
    letter-spacing:.3px;
    font-size: 13px;
  }
  table td { font-size: 13px; }
  table tr:nth-child(even) { background-color: #faf7ff; }
  table tr:hover { background-color: #f4ecff; transition: background .2s ease; }
  .cards-small { line-height: 1.4; }
  /* Tutorial */
  .tutorial {
    margin-top: 8px;
    max-width: 640px;
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    border-radius: 14px;
    padding: 10px 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    font-size: 14px;
  }
  .tutorial p { margin: 6px 0; text-align: left; }
  /* Mode split */
  #mode-screen {
    display: none;
    align-items: stretch;
    padding: 0;
    min-height: 100vh;
    width: 100%;
  }
  .mode-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    width: 100%;
    min-height: 100vh;
    position: relative;
  }
  .half {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    padding: 20px 10px;
  }
  .half::after { content: ""; position: absolute; inset: 0; }
  .half .content {
    z-index: 1;
    text-align: center;
    max-width: 520px;
    background: color-mix(in oklab, var(--card-bg) 75%, white 25%);
    border: 2px solid var(--accent-1);
    border-radius: 16px;
    padding: 18px 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  }
  .half.left { background: transparent; border-right: 1px dashed color-mix(in oklab, var(--accent-2) 60%, white); }
  .half.right { background: transparent; }
  .half.right::before {
    content: "";
    position: absolute;
    inset: 0;
    background: color-mix(in srgb, var(--bg-dark) 70%, transparent);
    z-index: 0;
  }
  .half h2 { margin: 4px 0 8px; }
  .half p { margin: 0; font-size: 14px; opacity: .9; }
  .badge {
    display: inline-block;
    margin-top: 8px;
    padding: 4px 8px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 12px;
    color: #fff;
    background: linear-gradient(180deg, var(--accent-1), var(--accent-2));
  }
  /* Stats */
  #stats-screen {
    min-height: 100vh;
    padding: 6px 10px 10px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .stats-grid {
    display:grid;
    grid-template-columns: minmax(340px, 1fr) minmax(420px, 1.2fr);
    gap: 12px;
    align-items: start;
  }
  .chart-card, .top-card, .aff-card {
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    padding: 8px;
    display:flex;
    flex-direction:column;
  }
  .chart-scroll { overflow-y: auto; max-height: 360px; padding-bottom: 6px; }
  .chart-container canvas { height: auto !important; max-width: 100%; }
  .top-scroll { overflow-y:auto; max-height: 220px; padding-bottom:6px; }
  .aff-scroll { overflow-y:auto; max-height: 220px; padding-bottom:6px; }
  .affinity-wrap { margin-top: 8px; display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .aff-card td.cards-small { font-size: 12px; line-height: 1.25; }
  /* Responsive */
  @media (max-width: 980px) {
    body { overflow:auto; }
    .stats-grid { grid-template-columns: 1fr; }
    .affinity-wrap { grid-template-columns: 1fr; }
  }
  @media (max-width: 760px) {
    .stats-grid, .affinity-wrap { grid-template-columns: 1fr !important; gap: 16px; }
    table th, table td { font-size: 13px; padding: 6px 8px; }
    .top-card table td, .aff-card table td { font-size: 12px; }
    .chart-scroll { max-height: 240px; }
    .top-scroll, .aff-scroll { max-height: 180px; }
  }
  strong { color: rgba(var(--petal-rgba), 1); font-weight: bold; }
</style>
</head>
<body>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Cartas</title>
<style>
  /* Aquí iría todo tu CSS */
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #fafafa;
  }
  .card {
    width: 300px;
    height: 400px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
    background: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .card img {
    width: 100%;
    height: auto;
    display: block;
  }
  #game-screen, #results, #stats-screen {
    display: none;
  }
  /* Kanji cayendo */
  .kanji-char {
    position: fixed;
    top: -10%;
    animation: fall linear infinite;
    color: rgba(0,0,0,0.15);
    pointer-events: none;
    z-index: 0;
  }
  .kanji-layer-a {
    animation-duration: 24s;
  }
  .kanji-layer-b {
    animation-duration: 32s;
  }
  @keyframes fall {
    0% { transform: translateY(-10vh) rotate(var(--r)); }
    100% { transform: translateY(110vh) rotate(var(--r)); }
  }
</style>
</head>
<body>

<div id="start-screen" style="display:flex;">Pantalla de inicio</div>
<div id="mode-screen"></div>
<div id="game-screen"></div>
<div id="results"></div>
<div id="stats-screen"></div>

<script>
/************ Variables globales ************/
let playerName = "";
let mode = "";
let index = 0;
let accepted = [];
let meh = [];
let rejected = [];
let mehLimit = 3;
let container = document.getElementById("game-screen");
let saveEndpoint = "/api/save";
let dataUrl = "results/data.json";
let statsChartInstance = null;

/************ Funciones base ************/
function goToStart() {
  document.getElementById('start-screen').style.display = 'flex';
  document.getElementById('mode-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = 'none';
  document.getElementById('results').style.display = 'none';
  document.getElementById('stats-screen').style.display = 'none';
}
window.goToStart = goToStart;

/************ Tarjetas + Swipe ************/
function createCard(item) {
  const card = document.createElement('div');
  card.className = 'card';
  const img = document.createElement('img');
  img.src = item.img;
  img.alt = item.name;
  const name = document.createElement('div');
  name.textContent = item.name;
  card.appendChild(img);
  card.appendChild(name);
  attachSwipe(card);
  return card;
}

function showNextCard(initial=false) {
  if (!initial) container.innerHTML = "";
  if (index < data.length) {
    const card = createCard(data[index]);
    container.appendChild(card);
  } else {
    showResults();
  }
}

function attachSwipe(el) {
  let startX=0, startY=0, dx=0, dy=0, active=false;

  const onStart = (x,y) => {
    active=true; startX=x; startY=y; dx=0; dy=0; el.style.transition="";
  };
  const onMove = (x,y) => {
    if(!active) return;
    dx = x - startX;
    dy = y - startY;
    const rot = dx * 0.05;
    el.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
    el.style.opacity = String(1 - Math.min(0.6, Math.abs(dx)/300 + Math.max(0, -dy)/300));
  };
  const onEnd = () => {
    if(!active) return;
    active=false;
    const THX = 80, THY = -80;
    if (dx <= -THX) { commitDecision(-1, el); return; }
    if (dx >=  THX) { commitDecision( 1, el); return; }
    if (dy <=  THY) { commitDecision( 0, el); return; }
    el.style.transition="transform .2s ease, opacity .2s ease";
    el.style.transform="translate(0,0) rotate(0)";
    el.style.opacity="1";
  };

  // Touch
  el.addEventListener("touchstart", (e)=>onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
  el.addEventListener("touchmove",  (e)=>onMove(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
  el.addEventListener("touchend",   onEnd);

  // Mouse
  el.addEventListener("mousedown", (e)=>onStart(e.clientX, e.clientY));
  window.addEventListener("mousemove", (e)=>onMove(e.clientX, e.clientY));
  window.addEventListener("mouseup", onEnd);
}

function commitDecision(direction, el){
  const name = el.querySelector('div').textContent;
  if (direction === 1) accepted.push(name);
  else if (direction === -1) rejected.push(name);
  else {
    if (meh.length >= mehLimit) {
      alert("Por favor, mójate un poco más…");
      el.style.transition="transform .2s ease, opacity .2s ease";
      el.style.transform="translate(0,0) rotate(0)";
      el.style.opacity="1";
      return;
    }
    meh.push(name);
  }
  index++;
  container.innerHTML = "";
  showNextCard();
}

function handleDecision(direction){
  const el = container.querySelector('.card');
  if (!el) return;
  commitDecision(direction, el);
}

/************ Resultados + Guardado ************/
function buildResultsTableRows(a, m, r){
  const maxRows = Math.max(a.length, m.length, r.length);
  const rows = [];
  for (let i=0;i<maxRows;i++){
    rows.push(`
      <tr>
        <td>${a[i] ? a[i] : ""}</td>
        <td>${m[i] ? m[i] : ""}</td>
        <td>${r[i] ? r[i] : ""}</td>
      </tr>
    `);
  }
  return rows.join("");
}

async function showResults() {
  document.getElementById('game-screen').style.display = 'none';
  document.getElementById('results').style.display = 'flex';
  const now = new Date();
  const dateTime = now.toLocaleString();
  setPlayerInfo(dateTime);

  const tbody = document.getElementById('results-body');
  tbody.innerHTML = buildResultsTableRows(accepted, meh, rejected);

  try {
    await fetch(saveEndpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ player: playerName, date: dateTime, mode, accepted, meh, rejected })
    });
  } catch (e) {
    console.warn("No se pudo guardar en la API:", e);
  }
}

/************ Kanji cayendo ************/
function initKanjiRain(){
  const KANJI = "日月火水木金土山川田人口女子学校先生時間東京日本大中小上下左右入口出口駅車電気食飲見行来会話読書映画音楽花愛友幸楽海空風雨雪猫犬鳥龍心星春夏秋冬夢道神寺社桜光美和新古旅食買飲遊語学写真";
  const pick = () => KANJI[Math.floor(Math.random() * KANJI.length)];
  const COUNT_A = 40;
  const COUNT_B = 40;

  const makeChar = (layerClass) => {
    const el = document.createElement('span');
    el.className = `kanji-char ${layerClass}`;
    el.textContent = pick();
    const vw = Math.random() * 100;
    const size = 14 + Math.random() * 18;
    const rot = (Math.random() * 60 - 30) + "deg";
    const delay = (-Math.random() * 32).toFixed(2) + "s";
    const drift = (Math.random() * 60 - 30) + "px";

    el.style.setProperty('--x', vw + 'vw');
    el.style.setProperty('--r', rot);
    el.style.fontSize = size + 'px';
    el.style.animationDelay = delay;
    el.style.transform = `translateX(${drift}) translateY(-12vh) rotate(${rot})`;

    document.body.appendChild(el);
  };

  for (let i = 0; i < COUNT_A; i++) makeChar('kanji-layer-a');
  for (let i = 0; i < COUNT_B; i++) makeChar('kanji-layer-b');
}

/************ Funciones para manejar resultados ************/
async function getSeenCardsForPlayer(player) {
  try {
    const res = await fetch('results/data.json');
    const data = await res.json();
    return data[player] || {};
  } catch (e) {
    console.error('Error al leer data.json', e);
    return {};
  }
}

async function saveResult(player, cardId, action) {
  try {
    await fetch('/api/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player, cardId, action })
    });
  } catch (e) {
    console.error('Error al guardar resultado', e);
  }
}

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

let currentPlayer = 'jugador1';
let cards = [...document.querySelectorAll('.card')];

async function initGame() {
  const seenCards = await getSeenCardsForPlayer(currentPlayer);
  cards.forEach(card => {
    if (seenCards[card.dataset.id]) {
      card.style.display = 'none';
    }
  });
  cards = shuffle(cards);
}

function handleCardAction(card, action) {
  card.style.display = 'none';
  saveResult(currentPlayer, card.dataset.id, action);
}

window.addEventListener('DOMContentLoaded', () => {
  applyRandomTheme();
  initKanjiRain();
  document.getElementById("start-screen").style.display = "flex";
  initGame();
});
</script>
</body>
</html>

<script>
/* Aquí iría tu JavaScript corregido */
</script>
</body>
</html>
