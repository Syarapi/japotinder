<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Japontinder</title>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    /* Paleta fija para botones/series (NO aleatoria) */
    --yes:#87cefa;          /* azul – Aquí sí */
    --meh:#8a5adf;          /* morado – Me da igual */
    --no:#ff7aa3;           /* rosa – Pasando */

    /* Variables de tema aleatorio (sí cambian) */
    --ink:#333;
    --bg-light:#fff7fb;
    --bg-mid:#ffe3ef;
    --bg-dark:#d38cb1;
    --card-bg:#ffffffee;
    --accent-1:#d7a6f1;     /* títulos/contornos */
    --accent-2:#b48ad6;
    --petal-rgba: 255,182,193; /* se sobreescribe desde JS */
  }

  /* ===== Fondo con pétalos (sin degradado) ===== */
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    color: var(--ink);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--bg-light);
    position: relative;
    overflow: hidden; /* sin scroll de página */
  }
  body::before, body::after{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events:none;
    background-image:
      radial-gradient(14px 9px at 10px 10px, rgba(var(--petal-rgba),0.25) 40%, transparent 41%),
      radial-gradient(12px 8px at 40% 30%, rgba(var(--petal-rgba),0.18) 40%, transparent 41%),
      radial-gradient(10px 7px at 70% 60%, rgba(var(--petal-rgba),0.15) 40%, transparent 41%),
      radial-gradient(12px 8px at 85% 20%, rgba(var(--petal-rgba),0.18) 40%, transparent 41%);
    animation: petals 24s linear infinite;
    filter: blur(0.2px);
  }
  body::after{
    animation-duration: 32s;
    opacity: .6;
  }
  @keyframes petals {
    0% { background-position: 0 -10vh, 20vw -20vh, 60vw -15vh, 85vw -25vh; }
    100% { background-position: 0 120vh, 20vw 130vh, 60vw 125vh, 85vw 135vh; }
  }

  h1, h2, h3 { font-family: 'Yuji Syuku', serif; text-align: center; margin: 10px 0; }
  h1 { color: var(--accent-1); text-shadow: 0 2px 0 #fff; }
  h2 { color: var(--accent-2); }
  h3 { color: var(--accent-1); }

  /* Contenedores principales */
  #start-screen, #mode-screen, #results, #stats-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 16px;
    width: 100%;
    height: 100vh;         /* ocupar viewport */
    box-sizing: border-box;
  }
  #start-screen { display: flex; justify-content: center; gap: 15px; }

  /* Tarjetas */
  #card-container {
    position: relative;
    width: 90%;
    max-width: 520px;
    height: 62vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    width: 100%;
    height: 100%;
    background: var(--card-bg);
    backdrop-filter: blur(3px);
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 18px;
    box-sizing: border-box;
    border: 2px solid var(--accent-1);
    will-change: transform;
  }
  .card img {
    max-height: 85%;
    max-width: 100%;
    object-fit: cover;
    border-radius: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    user-select: none;
    -webkit-user-drag: none;
  }
  .card div { font-weight: 600; color: var(--ink); padding-top: 6px; }

  /* Botonera */
  #buttons {
    margin-top: 12px;
    display: flex;
    gap: 12px;
    z-index: 10;
  }
  .btn {
    padding: 12px 18px;
    font-size: 16px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.12);
    color: white;
  }
  .accept { background: linear-gradient(180deg, var(--yes) 0%, #5fb5ef 100%); }
  .meh    { background: linear-gradient(180deg, var(--meh) 0%, #7343d8 100%); }
  .reject { background: linear-gradient(180deg, var(--no) 0%, #ff5f93 100%); }
  .stats-btn { background: linear-gradient(180deg, var(--accent-1) 0%, var(--accent-2) 100%); color: #fff; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.16); }
  .btn:active { transform: translateY(0); opacity:.95; }

  .results-container { display: flex; gap: 28px; justify-content: center; flex-wrap: wrap; }
  .list { margin: 6px 0; }
  ul { list-style: none; padding: 0; font-size: 16px; }
  input {
    padding: 10px 12px; font-size: 16px; border-radius: 10px;
    border: 2px solid var(--accent-1); width: 220px; text-align: center; background: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
  }

  /* Modo elección */
  .mode-grid{
    display:grid; grid-template-columns: 1fr; gap:12px; max-width:720px; width:100%;
  }
  .mode-card{
    background: var(--card-bg); border:2px solid var(--accent-1); border-radius:16px;
    padding:12px; box-shadow: 0 8px 24px rgba(0,0,0,.12);
  }
  .mode-card p{ margin:6px 0 0 0; color:#555; font-size: 14px; }
  @media (min-width:760px){ .mode-grid{ grid-template-columns: 1fr 1fr; } }

  /* Tablas */
  table {
    border-collapse: collapse;
    width: 100%;
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border: 2px solid var(--accent-1);
    table-layout: fixed;
  }
  table th, table td { padding: 8px 10px; border-bottom: 1px solid #f0e7f8; text-align: left; word-wrap: break-word; }
  table th {
    background: linear-gradient(180deg, var(--accent-2) 0%, var(--accent-1) 100%);
    color: white; letter-spacing:.3px; position: sticky; top: 0; z-index: 1;
  }
  table tr:nth-child(even) { background-color: #faf7ff; }
  table tr:hover { background-color: #f4ecff; transition: background .2s ease; }

  .notice { color: var(--accent-2); margin-top: 6px; }
  .error { color: #d6456a; margin-top: 6px; }
  .muted { color: #777; }

  /* ===== Pantalla de estadísticas sin scroll global ===== */
  #stats-screen > h2 { margin: 6px 0 8px; }
  .stats-layout {
    display: grid;
    grid-template-rows: auto 1fr;  /* fila superior fija, fila inferior ocupa resto */
    gap: 10px;
    width: 100%;
    max-width: 1200px;
    height: calc(100vh - 90px); /* dentro del viewport, sin scroll de página */
    box-sizing: border-box;
  }

  /* Fila superior: gráfico (izq) + tabla top (dcha) mismas alturas */
  .top-row {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 10px;
    min-height: 280px;
    max-height: 360px;
    height: 36vh; /* altura consistente */
  }
  .panel {
    background: var(--card-bg);
    border: 2px solid var(--accent-1);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    min-height: 0; /* necesario para overflow en grid */
  }
  .panel-header { padding: 8px 12px; font-weight: 700; color: var(--accent-2); }
  .panel-body   { padding: 8px; overflow: auto; }

  .chart-scroll { width: 100%; overflow-x: auto; overflow-y: hidden; }
  .chart-scroll canvas { display: block; }
  .chart-container canvas { height: 260px !important; } /* se ajusta a la altura del panel */

  /* Fila inferior: dos columnas de afinidad, con scroll interno */
  .affinity-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; min-height: 0;
  }

  /* Tablas de afinidad: tipografías más pequeñas para tarjetas */
  .affinity-table td.card-list { font-size: 12px; line-height: 1.25; }

  /* Responsive */
  @media (max-width: 980px){
    .top-row { grid-template-columns: 1fr; height: 48vh; }
    .affinity-row { grid-template-columns: 1fr; }
    .chart-container canvas { height: 220px !important; }
  }
</style>
</head>
<body>

<!-- Pantalla de inicio -->
<div id="start-screen">
  <div style="text-align:center">
    <h1>Japontinder</h1>
    <p>¿Quién eres? O no empezamos ò_ó</p>
    <input type="text" id="username" placeholder="Tu nombre" />
    <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="btn accept" id="btnNameNext">Siguiente</button>
      <button class="btn stats-btn" onclick="showStats()">Ver estadísticas</button>
    </div>
  </div>
</div>

<!-- Elección de modo -->
<div id="mode-screen">
  <h2>Elige cómo jugar</h2>
  <div class="mode-grid">
    <div class="mode-card">
      <button class="btn stats-btn" id="btnShort">Versión corta</button>
      <p>20 tarjetas al azar. Puedes usar “Me da igual” <strong>5 veces</strong>.</p>
    </div>
    <div class="mode-card">
      <button class="btn stats-btn" id="btnFull">Completo</button>
      <p>Todas las tarjetas en orden aleatorio. “Me da igual” disponible <strong>10 veces</strong>.</p>
    </div>
  </div>
  <div style="margin-top:10px">
    <button class="btn reject" onclick="goToStart()">Volver</button>
  </div>
</div>

<!-- Juego -->
<div id="game-screen" style="display:none; flex-direction: column; align-items: center;">
  <div id="card-container"></div>
  <div id="buttons">
    <button class="btn reject" onclick="handleDecision(-1)">Pasando</button>
    <button class="btn meh" onclick="handleDecision(0)">Me da igual</button>
    <button class="btn accept" onclick="handleDecision(1)">Aquí sí</button>
  </div>
</div>

<!-- Resultados -->
<div id="results">
  <h2>Resultados</h2>
  <p id="player-info"></p>
  <div class="results-container">
    <div class="list">
      <h3>Aquí sí</h3>
      <ul id="accepted-list"></ul>
    </div>
    <div class="list">
      <h3>Me da igual</h3>
      <ul id="meh-list"></ul>
    </div>
    <div class="list">
      <h3>Pasando</h3>
      <ul id="rejected-list"></ul>
    </div>
  </div>
  <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <button class="btn stats-btn" onclick="showStats()">Ver estadísticas</button>
    <button class="btn reject" onclick="restartGame()">Volver al inicio</button>
  </div>
</div>

<!-- Pantalla de estadísticas -->
<div id="stats-screen">
  <h2>Estadísticas</h2>

  <div class="stats-layout">
    <!-- Fila superior: gráfico (izq) + top tabla (dcha) -->
    <div class="top-row">
      <div class="panel">
        <div class="panel-header">Distribución de votos por tarjeta</div>
        <div class="panel-body">
          <div class="chart-scroll chart-container">
            <canvas id="statsChart"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">TOP tarjetas con más “sí”</div>
        <div class="panel-body" id="topCardsWrap">
          <!-- tabla inject -->
        </div>
      </div>
    </div>

    <!-- Fila inferior: afinidades -->
    <div class="affinity-row" id="affinityGrids" style="display:none;">
      <div class="panel">
        <div class="panel-header">Ranking de afinidad (todos los jugadores)</div>
        <div class="panel-body" id="affinityGlobal">
          <!-- tabla inject -->
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">Jugadores más afines contigo</div>
        <div class="panel-body" id="affinityPersonal">
          <!-- tabla inject -->
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:8px;">
    <button class="btn reject" onclick="goToStart()">Volver</button>
  </div>
</div>

<script>
  /************ Config ************/
  const saveEndpoint = "/api/save"; // tu ruta backend
  const dataUrl = "https://raw.githubusercontent.com/Syarapi/japotinder/main/results/data.json";

  /************ Datos base ************/
  const originalData = [
    { name: "Disney Tokyo", img: "img/disney.jpg" },
    { name: "Gotokuji", img: "img/gotokuji.jpg" },
    { name: "Pokemon Cafe", img: "img/pokemon.jpg" },
    { name: "Shikisai no oka", img: "img/shikisai.jpg" },
    { name: "Shinkansen Hello Kitty", img: "img/hello-kitty.jpg" },
    { name: "Maid cafe", img: "img/maid.jpg" },
    { name: "Nabana no sato", img: "img/nabana.jpg" },
    { name: "Otaru", img: "img/otaru.jpg" },
    { name: "Nagano y monos de nieve", img: "img/nagano.jpg" },
    { name: "RJ Cafe Osaka", img: "img/rj-cafe.jpg" },
    { name: "Kumachan Onsen Tokyo", img: "img/kumachan.jpg" },
    { name: "Enoshima", img: "img/enoshima.jpg" },
    { name: "Ginzan Onsen", img: "img/ginzan.jpg" },
    { name: "Tarde de recreativas", img: "img/arcade.jpg" },
    { name: "Shibazakura park Hokkaido", img: "img/shibazakura.jpg" },
    { name: "Musical Tokyo Revengers", img: "img/tokyo-revengers.jpg" },
    { name: "Eventos Kisekoi/Sailor Moon", img: "img/kisekoi.jpg" },
    { name: "Museo/cafe de los yokai", img: "img/yokai.jpg" },
    { name: "Kumamoto", img: "img/kumamoto.jpg" },
    { name: "Beppu", img: "img/beppu.jpg" },
    { name: "Bandai Museum", img: "img/bandai.jpg" }
  ];

  /************ Estado ************/
  let playerName = "";
  let mode = "short"; // "short" | "full"
  let data = [];
  let accepted = [];
  let rejected = [];
  let meh = [];
  let index = 0;
  let mehLimit = 5;
  let statsChartInstance = null;

  const container = document.getElementById('card-container');

  /************ Utilidades ************/
  const shuffleArray = (array) => array.slice().sort(() => Math.random() - 0.5);

  // Colores fijos para nombres: Alba=azul, Alicia/Vaini=morados, Sara=rosa, otros: sun pastel o mint fijo por hash
  function getNameColor(name){
    const n = (name || "").trim().toLowerCase();
    if(n === "alba")   return "#2f7bdc";          // azul
    if(n === "alicia" || n === "vaini") return "#8a5adf"; // morado
    if(n === "sara")   return "#ff6fa1";          // rosa
    // Otros: determinista entre amarillo pastel legible (sun) y verde menta
    const options = ["#ffd666", "#56e0b5"];
    let hash = 0; for(let i=0;i<n.length;i++){ hash = (hash*31 + n.charCodeAt(i))|0; }
    return options[Math.abs(hash)%options.length];
  }

  // Tema aleatorio (afecta fondos, bordes, acentos; NO los botones ni colores de series)
  function applyRandomTheme(){
    const themes = [
      { name:"sakura", light:"#fff7fb", mid:"#ffe3ef", dark:"#d38cb1", accent1:"#d7a6f1", accent2:"#b48ad6", petal:[220,120,160] },
      { name:"sky",    light:"#f2f9ff", mid:"#e0f1ff", dark:"#8dbfe6", accent1:"#a3c9ff", accent2:"#7fb2f0", petal:[120,160,220] },
      { name:"lav",    light:"#faf5ff", mid:"#efe3ff", dark:"#b48ad6", accent1:"#d7a6f1", accent2:"#b48ad6", petal:[150,110,200] },
      { name:"sun",    light:"#fff6cc", mid:"#ffe899", dark:"#d6b84d", accent1:"#f0d46a", accent2:"#e1b84f", petal:[220,190,80] },
      { name:"mint",   light:"#edfff7", mid:"#d8ffee", dark:"#68cba7", accent1:"#9fe6cc", accent2:"#68cba7", petal:[90,170,140] }
    ];
    const pick = themes[Math.floor(Math.random()*themes.length)];
    const root = document.documentElement.style;
    root.setProperty('--bg-light', pick.light);
    root.setProperty('--bg-mid', pick.mid);
    root.setProperty('--bg-dark', pick.dark);
    root.setProperty('--accent-1', pick.accent1);
    root.setProperty('--accent-2', pick.accent2);
    root.setProperty('--petal-rgba', `${pick.petal[0]},${pick.petal[1]},${pick.petal[2]}`);
  }

  function setPlayerInfo(dateTime){
    const spanColor = getNameColor(playerName);
    const html = `Jugador: <span style="font-weight:700; color:${spanColor}">${playerName}</span> | ${dateTime} | Modo: ${mode === 'short' ? 'Corto' : 'Completo'}`;
    document.getElementById('player-info').innerHTML = html;
  }

  // Lectura robusta de data.json
  function ensureArray(maybeArray) {
    if (Array.isArray(maybeArray)) return maybeArray;
    if (maybeArray && Array.isArray(maybeArray.games)) return maybeArray.games;
    return [];
  }

  /************ Flujo UI ************/
  document.getElementById("btnNameNext").addEventListener("click", () => {
    const nameInput = document.getElementById("username").value.trim();
    if (!nameInput) { alert("Que me digas quién eres o no jugamos ù3ú"); return; }
    playerName = nameInput;
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("mode-screen").style.display = "flex";
  });

  document.getElementById("btnShort").addEventListener("click", () => {
    mode = "short";
    mehLimit = 5;
    startGameWithMode();
  });
  document.getElementById("btnFull").addEventListener("click", () => {
    mode = "full";
    mehLimit = 10;
    startGameWithMode();
  });

  function startGameWithMode(){
    data = shuffleArray(originalData);
    if (mode === "short") data = data.slice(0, 20);
    index = 0; accepted = []; rejected = []; meh = [];
    container.innerHTML = "";
    document.getElementById("mode-screen").style.display = "none";
    document.getElementById("game-screen").style.display = "flex";
    showNextCard(true);
  }

  function restartGame() {
    document.getElementById("results").style.display = "none";
    document.getElementById("start-screen").style.display = "flex";
  }
  function goToStart() {
    document.getElementById("stats-screen").style.display = "none";
    document.getElementById("start-screen").style.display = "flex";
  }

  /************ Tarjetas + Swipe ************/
  function createCard(item) {
    const card = document.createElement('div'); card.className = 'card';
    const img = document.createElement('img'); img.src = item.img; img.alt = item.name;
    const name = document.createElement('div'); name.textContent = item.name;
    card.appendChild(img); card.appendChild(name);
    attachSwipe(card);
    return card;
  }

  function showNextCard(initial=false) {
    if (!initial) container.innerHTML = "";
    if (index < data.length) {
      const card = createCard(data[index]);
      container.appendChild(card);
    } else {
      showResults();
    }
  }

  // Swipe (izquierda=-1, derecha=1, arriba=0)
  function attachSwipe(el){
    let startX=0, startY=0, dx=0, dy=0, active=false;

    const onStart = (x,y) => { active=true; startX=x; startY=y; dx=0; dy=0; el.style.transition=""; };
    const onMove = (x,y) => {
      if(!active) return;
      dx = x - startX; dy = y - startY;
      const rot = dx * 0.05;
      el.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
      el.style.opacity = String(1 - Math.min(0.6, Math.abs(dx)/300 + Math.max(0, -dy)/300));
    };
    const onEnd = () => {
      if(!active) return;
      active=false;
      const THX = 80, THY = -80; // arriba es negativo
      if (dx <= -THX) { commitDecision(-1, el); return; }   // izquierda -> no
      if (dx >=  THX) { commitDecision( 1, el); return; }   // derecha  -> sí
      if (dy <=  THY) { commitDecision( 0, el); return; }   // arriba   -> meh
      el.style.transition="transform .2s ease, opacity .2s ease";
      el.style.transform="translate(0,0) rotate(0)";
      el.style.opacity="1";
    };

    // Touch
    el.addEventListener("touchstart", (e)=>onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
    el.addEventListener("touchmove",  (e)=>onMove(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
    el.addEventListener("touchend",   onEnd);

    // Mouse
    el.addEventListener("mousedown", (e)=>onStart(e.clientX, e.clientY));
    window.addEventListener("mousemove", (e)=>onMove(e.clientX, e.clientY));
    window.addEventListener("mouseup", onEnd);
  }

  function commitDecision(direction, el){
    const name = el.querySelector('div').textContent;
    if (direction === 1) accepted.push(name);
    else if (direction === -1) rejected.push(name);
    else {
      if (meh.length >= mehLimit) {
        alert("Por favor, mójate un poco más…");
        el.style.transition="transform .2s ease, opacity .2s ease";
        el.style.transform="translate(0,0) rotate(0)";
        el.style.opacity="1";
        return;
      }
      meh.push(name);
    }
    index++;
    container.innerHTML = "";
    showNextCard();
  }

  function handleDecision(direction){
    const el = container.querySelector('.card');
    if (!el) return;
    commitDecision(direction, el);
  }

  /************ Resultados + Guardado ************/
  async function showResults() {
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('results').style.display = 'flex';
    const now = new Date(); const dateTime = now.toLocaleString();
    setPlayerInfo(dateTime);

    const fillList = (id, arr) => {
      const ul = document.getElementById(id); ul.innerHTML="";
      arr.forEach(n => { const li = document.createElement('li'); li.textContent = n; ul.appendChild(li); });
    };
    fillList('accepted-list', accepted);
    fillList('meh-list', meh);
    fillList('rejected-list', rejected);

    try {
      await fetch(saveEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player: playerName, date: dateTime, mode, accepted, meh, rejected })
      });
    } catch (e) {
      console.warn("No se pudo guardar en la API:", e);
    }
  }

  /************ Estadísticas ************/
  async function showStats() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('mode-screen').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    document.getElementById('stats-screen').style.display = 'flex';

    const topCardsWrap = document.getElementById('topCardsWrap');
    const affinityWrap = document.getElementById('affinityGrids');
    const affinityGlobal = document.getElementById('affinityGlobal');
    const affinityPersonal = document.getElementById('affinityPersonal');

    // Limpia
    topCardsWrap.innerHTML = `<p class="muted">Cargando datos...</p>`;
    affinityWrap.style.display = "none";
    affinityGlobal.innerHTML = "";
    affinityPersonal.innerHTML = "";

    let games = [];
    try {
      const res = await fetch(`${dataUrl}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      games = ensureArray(json);
    } catch (err) {
      topCardsWrap.innerHTML = `<p class="error">No se pudo cargar <code>results/data.json</code>. Detalle: ${err.message}</p>`;
      destroyChart();
      return;
    }

    if (!games.length) {
      topCardsWrap.innerHTML = `<p class="notice">No hay partidas guardadas aún.</p>`;
      destroyChart();
      return;
    }

    // Normalizar
    const safeGames = games
      .filter(g => g && Array.isArray(g.accepted) && Array.isArray(g.rejected))
      .map(g => ({
        player: g.player || "¿anon?",
        mode: g.mode || "unknown",
        accepted: Array.isArray(g.accepted) ? g.accepted : [],
        meh: Array.isArray(g.meh) ? g.meh : [],
        rejected: Array.isArray(g.rejected) ? g.rejected : []
      }));

    // Conteos por tarjeta
    const stats = {};
    const upsert = (name, key) => {
      stats[name] = stats[name] || { yes:0, meh:0, no:0 };
      stats[name][key] += 1;
    };
    safeGames.forEach(g => {
      g.accepted.forEach(a => upsert(a, 'yes'));
      g.meh.forEach(m => upsert(m, 'meh'));
      g.rejected.forEach(r => upsert(r, 'no'));
    });

    const labels = Object.keys(stats).sort((a,b)=>a.localeCompare(b));
    const yesData = labels.map(l => stats[l].yes);
    const mehData = labels.map(l => stats[l].meh);
    const noData  = labels.map(l => stats[l].no);

    // Canvas ancho (scroll horizontal)
    const canvas = document.getElementById('statsChart');
    const desiredWidth = Math.max(labels.length * 42, 420);
    canvas.width = desiredWidth; canvas.height = 260;
    const ctx = canvas.getContext('2d');

    const getVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const grad = (hex) => { const g = ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,hex); g.addColorStop(1,hex); return g; };

    destroyChart();
    statsChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Aquí sí',   data: yesData, backgroundColor: grad(getVar('--yes')), borderRadius: 8, stack: 's' },
          { label: 'Me da igual', data: mehData, backgroundColor: grad(getVar('--meh')), borderRadius: 8, stack: 's' },
          { label: 'Pasando',  data: noData,  backgroundColor: grad(getVar('--no')),  borderRadius: 8, stack: 's' }
        ]
      },
      options: {
        responsive: false, maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { maxRotation: 60, minRotation: 0, autoSkip: false } },
          y: { stacked: true, beginAtZero: true }
        },
        plugins: {
          legend: {
            labels: { color: '#333', boxWidth: 14, usePointStyle: true, pointStyle: 'rectRounded', font: { size: 12 } }
          },
          tooltip: {
            backgroundColor: 'rgba(255,255,255,.95)',
            titleColor: '#333', bodyColor: '#333',
            borderColor: '#ddd', borderWidth: 1
          }
        },
        animation: { duration: 200 }
      }
    });

    // TOP tarjetas por "sí" (tabla derecha)
    const topCards = Object.entries(stats)
      .sort((a, b) => b[1].yes - a[1].yes || a[0].localeCompare(b[0]))
      .slice(0, 20);

    let topHtml = "<div style='height:100%; overflow:auto;'><table><thead><tr><th>Tarjeta</th><th>Sí</th><th>Meh</th><th>No</th></tr></thead><tbody>";
    topCards.forEach(([name, v]) => {
      topHtml += `<tr><td>${name}</td><td>${v.yes}</td><td>${v.meh}</td><td>${v.no}</td></tr>`;
    });
    topHtml += "</tbody></table></div>";
    topCardsWrap.innerHTML = topHtml;

    // === Afinidades (intersección de SÍ) ===
    const byPlayer = {};
    safeGames.forEach(g => {
      byPlayer[g.player] = byPlayer[g.player] || [];
      byPlayer[g.player].push(new Set(g.accepted));
    });
    // Reducir por jugador a unión de sus "sí"
    Object.keys(byPlayer).forEach(p => {
      const union = new Set();
      byPlayer[p].forEach(s => s.forEach(x => union.add(x)));
      byPlayer[p] = union;
    });

    const players = Object.keys(byPlayer).sort((a,b)=>a.localeCompare(b));

    // Ranking global de pares
    const pairs = [];
    for(let i=0;i<players.length;i++){
      for(let j=i+1;j<players.length;j++){
        const p1 = players[i], p2 = players[j];
        const s1 = byPlayer[p1], s2 = byPlayer[p2];
        const inter = [];
        s1.forEach(x => { if (s2.has(x)) inter.push(x); });
        if (inter.length>0) pairs.push({ a:p1, b:p2, common:inter.sort(), count:inter.length });
      }
    }
    pairs.sort((x,y)=> y.count - x.count || (x.a+x.b).localeCompare(y.a+y.b));

    // Afinidad del jugador actual
    let personalRows = [];
    if (playerName && byPlayer[playerName]) {
      const mine = byPlayer[playerName];
      players.filter(p=>p!==playerName).forEach(p => {
        const inter = [];
        byPlayer[p].forEach(x => { if (mine.has(x)) inter.push(x); });
        if (inter.length>0) personalRows.push({ player:p, count:inter.length, list:inter.sort() });
      });
      personalRows.sort((x,y)=> y.count - x.count || x.player.localeCompare(y.player));
    }

    // Tablas de afinidad (con colores de nombres y nombres de tarjetas pequeños)
    const colorNameHTML = (n) => `<span style="font-weight:600; color:${getNameColor(n)}">${n}</span>`;

    // Global
    let ghtml = "<div style='max-height:100%; overflow:auto;'><table class='affinity-table'><thead><tr><th>Par</th><th># Coincidencias SÍ</th><th>Tarjetas en común (SÍ)</th></tr></thead><tbody>";
    (pairs.slice(0,50)).forEach(row=>{
      const parHtml = `${colorNameHTML(row.a)} &nbsp;&amp;&nbsp; ${colorNameHTML(row.b)}`;
      ghtml += `<tr><td>${parHtml}</td><td>${row.count}</td><td class="card-list">${row.common.join(", ")}</td></tr>`;
    });
    ghtml += "</tbody></table></div>";
    affinityGlobal.innerHTML = ghtml;

    // Personal
    if (personalRows.length){
      let phtml = "<div style='max-height:100%; overflow:auto;'><table class='affinity-table'><thead><tr><th>Jugador</th><th># Coincidencias SÍ</th><th>Tarjetas en común (SÍ)</th></tr></thead><tbody>";
      personalRows.slice(0,50).forEach(r=>{
        phtml += `<tr><td>${colorNameHTML(r.player)}</td><td>${r.count}</td><td class="card-list">${r.list.join(", ")}</td></tr>`;
      });
      phtml += "</tbody></table></div>";
      affinityPersonal.innerHTML = phtml;
    } else {
      affinityPersonal.innerHTML = `<p class="notice">Juega una partida para ver tu afinidad personal.</p>`;
    }

    affinityWrap.style.display = "grid";
  }

  function destroyChart() {
    if (statsChartInstance) { statsChartInstance.destroy(); statsChartInstance = null; }
  }

  /************ Init ************/
  applyRandomTheme();
  document.getElementById("start-screen").style.display = "flex";
</script>
</body>
</html>
