<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Japontinder</title>
<link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
<style>
:root {
  --sakura-light:#fff7fb; --sakura-mid:#ffe3ef; --sakura-dark:#d38cb1; --sakura-a1:#d7a6f1; --sakura-a2:#b48ad6;
  --sky-light:#f2f9ff; --sky-mid:#e0f1ff; --sky-dark:#8dbfe6; --sky-a1:#a3c9ff; --sky-a2:#7fb2f0;
  --lav-light:#faf5ff; --lav-mid:#efe3ff; --lav-dark:#b48ad6; --lav-a1:#d7a6f1; --lav-a2:#b48ad6;
  --sun-light:#fff9e0; --sun-mid:#ffefb0; --sun-dark:#e0c050; --sun-a1:#f0d46a; --sun-a2:#e1b84f;
  --mint-light:#edfff7; --mint-mid:#d8ffee; --mint-dark:#68cba7; --mint-a1:#9fe6cc; --mint-a2:#68cba7;
  --btn-accept:#87cefa; --btn-reject:#ffc0cb; --btn-me:#dda0dd; --btn-stats:#dda0dd;
  --font-title:'Yuji Syuku', serif;
}
body,html{margin:0;padding:0;font-family:sans-serif; background:var(--sakura-light);}
.screen{display:none;width:100vw;height:100vh;align-items:center;justify-content:center;flex-direction:column;position:relative;}
.screen.active{display:flex;}
h1,h2,h3{font-family:var(--font-title);}
button{padding:10px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer;}
.centered{display:flex;flex-direction:column;align-items:center;justify-content:center;}
input[name="playerName"]{padding:8px 12px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:12px;}

/* Pantalla selección modo */
.mode-split{position:relative;width:100vw;height:100vh;display:grid;grid-template-columns:1fr 1fr;}
.mode-half{display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;transition:transform .15s ease;}
.mode-half:hover{transform:scale(1.015);}
.mode-title{font-size:clamp(26px,4vw,40px);font-weight:800;text-align:center;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.2);}
.mode-desc{font-size:clamp(14px,2vw,18px);opacity:.95;text-align:center;max-width:580px;color:#fff;}

/* Pantalla juego */
#screen-game .card-container{max-height:80vh;width:90vw;max-width:400px;display:flex;justify-content:center;align-items:center;}
#screen-game .btns-row{margin-top:12px;display:flex;justify-content:center;gap:12px;flex-wrap:wrap;}
#screen-game button{min-width:100px;}

/* Pantalla estadísticas */
#screen-stats{overflow-x:auto;padding:12px;}
#screen-stats table{width:100%;max-width:100%;border-collapse:collapse;display:block;}
#screen-stats th, #screen-stats td{border:1px solid #ccc;padding:6px 8px;text-align:center;font-size:14px;}
#screen-stats th{background:var(--sky-mid);}

/* Tutorial */
.tutorial{background:var(--sun-light);padding:12px;border-radius:8px;margin-bottom:12px;text-align:center;font-size:14px;}
</style>
</head>
<body>

<!-- Pantalla Inicio -->
<div id="screen-start" class="screen active centered">
  <h1>Japontinder</h1>
  <div class="tutorial">
    Selecciona por botón o haz swipe:<br>
    Arriba=Me da igual, Derecha=Sí, Izquierda=No
  </div>
  <input type="text" id="playerName" name="playerName" placeholder="Escribe tu nombre">
  <button id="startBtn">Comenzar</button>
  <button id="statsBtn">Ver estadísticas</button>
</div>

<!-- Pantalla selección modo -->
<div id="screen-mode" class="screen">
  <div class="mode-split">
    <div class="mode-half" id="mode-short" style="background:var(--sakura-mid);">
      <div class="mode-title">Corto</div>
      <div class="mode-desc">20 tarjetas, 5 "Me da igual"</div>
    </div>
    <div class="mode-half" id="mode-full" style="background:var(--sky-mid);">
      <div class="mode-title">Completo</div>
      <div class="mode-desc">Todas las tarjetas, 10 "Me da igual"</div>
    </div>
  </div>
</div>

<!-- Pantalla juego -->
<div id="screen-game" class="screen centered">
  <div class="card-container" id="card-container"></div>
  <div class="btns-row">
    <button id="btn-reject" style="background:var(--btn-reject)">No</button>
    <button id="btn-me" style="background:var(--btn-me)">Me da igual</button>
    <button id="btn-accept" style="background:var(--btn-accept)">Sí</button>
  </div>
</div>

<!-- Pantalla resultado -->
<div id="screen-result" class="screen centered">
  <h1>Resultados</h1>
  <div id="result-content"></div>
  <button id="result-stats-btn" style="background:var(--btn-stats)">Ver estadísticas</button>
  <button id="result-home-btn">Volver al inicio</button>
</div>

<!-- Pantalla estadísticas -->
<div id="screen-stats" class="screen centered">
  <h1>Estadísticas globales</h1>
  <div id="stats-content"></div>
  <button id="back-home-btn" style="background:var(--btn-accept)">Volver al inicio</button>
</div>

<script>
const BASE_CARDS = [
  { name: "Disney Tokyo", img: "img/disney.jpg" },
  { name: "Gotokuji", img: "img/gotokuji.jpg" },
  { name: "Pokemon Cafe", img: "img/pokemon.jpg" },
  { name: "Shikisai no oka", img: "img/shikisai.jpg" },
  { name: "Shinkansen Hello Kitty", img: "img/hello-kitty.jpg" },
  { name: "Maid cafe", img: "img/maid.jpg" },
  { name: "Nabana no sato", img: "img/nabana.jpg" },
  { name: "Otaru", img: "img/otaru.jpg" },
  { name: "Nagano y monos de nieve", img: "img/nagano.jpg" },
  { name: "RJ Cafe Osaka", img: "img/rj-cafe.jpg" },
  { name: "Kumachan Onsen Tokyo", img: "img/kumachan.jpg" },
  { name: "Enoshima", img: "img/enoshima.jpg" },
  { name: "Ginzan Onsen", img: "img/ginzan.jpg" },
  { name: "Tarde de recreativas", img: "img/arcade.jpg" },
  { name: "Shibazakura park Hokkaido", img: "img/shibazakura.jpg" },
  { name: "Musical Tokyo Revengers", img: "img/tokyo-revengers.jpg" },
  { name: "Eventos Kisekoi/Sailor Moon", img: "img/kisekoi.jpg" },
  { name: "Museo/cafe de los yokai", img: "img/yokai.jpg" },
  { name: "Kumamoto", img: "img/kumamoto.jpg" },
  { name: "Beppu", img: "img/beppu.jpg" },
  { name: "Bandai Museum", img: "img/bandai.jpg" }
];

let currentPlayer = '';
let gameMode = '';
let currentCards = [];
let currentIndex = 0;
let meCount = 0;
let maxMe = 0;
let results = [];

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById('startBtn').onclick=()=>{
  const name=document.getElementById('playerName').value.trim();
  if(!name) return alert('Debes poner tu nombre');
  currentPlayer=name;
  showScreen('screen-mode');
};

document.getElementById('mode-short').onclick=()=>{
  gameMode='Corto'; currentCards=BASE_CARDS.slice(0,20); maxMe=5; startGame();
};
document.getElementById('mode-full').onclick=()=>{
  gameMode='Completo'; currentCards=[...BASE_CARDS]; maxMe=10; startGame();
};

function startGame(){
  currentIndex=0; meCount=0; results=[];
  showCard();
  showScreen('screen-game');
}

function showCard(){
  const cardContainer=document.getElementById('card-container');
  if(currentIndex>=currentCards.length){showResults(); return;}
  const c=currentCards[currentIndex];
  cardContainer.innerHTML=`<img src="${c.img}" alt="${c.name}" style="width:100%;border-radius:12px;"><h2>${c.name}</h2>`;
}

function vote(v){
  if(v==='Me da igual' && meCount>=maxMe) return alert('Has usado todos los "Me da igual"');
  if(v==='Me da igual') meCount++;
  results.push({name:currentCards[currentIndex].name,vote:v});
  currentIndex++; showCard();
}

document.getElementById('btn-reject').onclick=()=>vote('No');
document.getElementById('btn-me').onclick=()=>vote('Me da igual');
document.getElementById('btn-accept').onclick=()=>vote('Sí');

function showResults(){
  const c=document.getElementById('result-content');
  c.innerHTML=results.map(r=>`${r.name}: ${r.vote}`).join('<br>');
  saveResults(currentPlayer,results);
  showScreen('screen-result');
}

document.getElementById('result-home-btn').onclick=()=>showScreen('screen-start');
document.getElementById('result-stats-btn').onclick=()=>showStatistics();
document.getElementById('statsBtn').onclick=()=>showStatistics();
document.getElementById('back-home-btn').onclick=()=>showScreen('screen-start');

// Fetch data.json y mostrar estadísticas
async function fetchResults(){
  try{
    const res=await fetch('results/data.json?' + Date.now());
    if(!res.ok) return [];
    return await res.json();
  }catch(e){console.error(e); return [];}
}

async function showStatistics(){
  const data=await fetchResults();
  const statsContent=document.getElementById('stats-content');
  statsContent.innerHTML='';
  if(!data.length){statsContent.innerHTML='<p>No hay datos</p>';showScreen('screen-stats');return;}
  const votes={};
  data.forEach(g=>{
    g.results.forEach(r=>{
      if(!votes[r.name]) votes[r.name]={Sí:0,No:0,'Me da igual':0};
      votes[r.name][r.vote]++;
    });
  });
  const table=document.createElement('table');
  const header=document.createElement('tr');
  header.innerHTML='<th>Tarjeta</th><th>Sí</th><th>No</th><th>Me da igual</th>';
  table.appendChild(header);
  Object.keys(votes).forEach(k=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${k}</td><td>${votes[k]['Sí']}</td><td>${votes[k]['No']}</td><td>${votes[k]['Me da igual']}</td>`;
    table.appendChild(row);
  });
  statsContent.appendChild(table);
  showScreen('screen-stats');
}

// Guardar resultados vía API
async function saveResults(player, results){
  try{
    await fetch('/api/save',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({player,results,date:new Date().toISOString()})
    });
  }catch(e){console.error('Error guardando resultados',e);}
}
</script>
</body>
</html>
